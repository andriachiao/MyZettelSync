<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ZettelStudio | Pro Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dropbox.js/10.11.0/Dropbox-sdk.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@700&family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background: #f5f5f5; height: 100vh; overflow: hidden; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* 核心視圖控制 */
        #midEditor, #midBoard, #studioSide { display: none; }
        .view-input #midEditor { display: flex; }
        .view-board #midBoard { display: flex; }
        .view-studio #studioSide { display: flex; flex: 1; }
        .view-studio.show-board #midBoard { display: flex; width: 450px; border-right: 4px solid black; }

        .card-grid { display: grid; grid-template-columns: repeat(auto-fill, 280px); grid-auto-rows: 320px; gap: 1.5rem; justify-content: center; }
        .board-card { border: 3px solid #000; background: #fff; box-shadow: 6px 6px 0 #000; cursor: pointer; display: flex; flex-direction: column; transition: 0.1s; }
        .board-card:hover { transform: translate(-2px, -2px); box-shadow: 9px 9px 0 #000; }
        
        #searchBar { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); top: -70px; }
        #searchBar.active { top: 0; }
        .active-type { background: black !important; color: white !important; }
    </style>
</head>
<body id="mainBody" class="flex flex-col h-screen view-input">

    <div id="searchBar" class="fixed left-0 right-0 h-16 bg-black z-[200] flex items-center px-8 shadow-2xl">
        <span class="text-white opacity-40 font-black mr-4 mono">FIND:</span>
        <input id="searchInput" class="w-full bg-transparent text-white text-2xl outline-none font-bold italic" placeholder="Type keywords or tags...">
        <button onclick="toggleSearch()" class="text-white border border-white/30 px-3 py-1 text-[10px] font-black">ESC</button>
    </div>

    <header class="h-14 border-b-4 border-black flex items-center justify-between px-6 bg-white z-[100]">
        <div class="flex items-center gap-6">
            <h1 class="text-lg font-900 uppercase italic tracking-tighter">ZettelStudio</h1>
            <div id="linkBanner" class="hidden bg-blue-600 text-white text-[9px] font-black px-4 py-1 animate-pulse">LINKING MODE</div>
        </div>
        <div class="flex gap-3">
            <button id="studioBoardToggle" onclick="toggleStudioBoard()" class="hidden text-[9px] font-black border-2 border-black px-3 py-1 bg-yellow-400">SHOW BOARD</button>
            <button onclick="handleCloud()" id="cloudBtn" class="text-[9px] font-black border-2 border-black px-3 py-1 bg-blue-500 text-white uppercase">Link Dropbox</button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <aside class="w-60 border-r-4 border-black bg-white flex flex-col shrink-0">
            <div class="flex-1 overflow-y-auto no-scrollbar">
                <div class="p-3 bg-zinc-50 text-[8px] font-black opacity-40 border-b uppercase">Vaults</div>
                <div class="p-4 text-xs font-bold border-b hover:bg-black hover:text-white cursor-pointer flex justify-between" onclick="filterBoard('Idea')"><span>Idea 盒</span><span id="c-i">0</span></div>
                <div class="p-4 text-xs font-bold border-b hover:bg-black hover:text-white cursor-pointer flex justify-between" onclick="filterBoard('摘錄')"><span>摘錄盒</span><span id="c-q">0</span></div>
                
                <div class="p-3 bg-zinc-50 text-[8px] font-black opacity-40 border-y uppercase">Keywords</div>
                <div id="tagBox"></div>

                <div class="p-3 bg-zinc-50 text-[8px] font-black opacity-40 border-y uppercase">Timeline</div>
                <div id="timeBox"></div>
            </div>
        </aside>

        <main id="midBoard" class="flex-[1.5] flex flex-col bg-zinc-100 overflow-hidden">
            <div id="boardGrid" class="flex-1 overflow-y-auto p-8 card-grid no-scrollbar"></div>
        </main>

        <main id="midEditor" class="flex-1 flex flex-col items-center pt-24 bg-zinc-100">
            <div class="max-w-xl w-full bg-white p-8 border-4 border-black shadow-[12px_12px_0_0_#000]">
                <div class="flex border-2 border-black w-fit mb-4 text-[10px] font-black">
                    <button id="ti" class="px-4 py-1 active-type">IDEA (C+S+1)</button>
                    <button id="tq" class="px-4 py-1">QUOTE (C+S+2)</button>
                </div>
                <textarea id="mainIn" class="w-full h-64 text-xl outline-none leading-relaxed resize-none font-medium" placeholder="Write here..."></textarea>
                <div class="mt-4 flex justify-between items-center opacity-30 text-[9px] font-black uppercase">
                    <span>Cmd+Shift+S to Save & Sync</span>
                    <span id="syncIndicator">Offline</span>
                </div>
            </div>
        </main>

        <aside id="studioSide" class="bg-white flex flex-col overflow-hidden">
            <div class="p-6 border-b-4 border-black flex justify-between items-end">
                <input id="projName" class="font-900 text-2xl uppercase outline-none flex-1" value="Untitled Draft">
                <span class="text-[8px] font-black opacity-20 ml-2">C+S+E to Export</span>
            </div>
            <div id="studioCanvas" class="flex-1 overflow-y-auto p-10 no-scrollbar space-y-8"></div>
        </aside>
    </div>

<script>
    const CLIENT_ID = '2zshj5fwkxe18e6';
    let dbx = null;
    let cards = JSON.parse(localStorage.getItem('Z_V14_Cards')) || [];
    let project = JSON.parse(localStorage.getItem('Z_V14_Proj')) || { segments: [] };
    let currentType = 'Idea';
    let linkSourceId = null;

    // --- 1. 快捷鍵映射修復 ---
    window.addEventListener('keydown', e => {
        const cmdShift = (e.metaKey || e.ctrlKey) && e.shiftKey;
        
        // 類型切換 (1, 2)
        if (cmdShift && e.key === '!') { e.preventDefault(); setType('Idea'); }
        if (cmdShift && e.key === '@') { e.preventDefault(); setType('摘錄'); }
        
        // 模式切換 (M)
        if (cmdShift && e.key.toLowerCase() === 'm') { 
            e.preventDefault(); 
            const isInput = document.body.classList.contains('view-input');
            changeView(isInput ? 'studio' : 'input'); 
        }

        // 保存與同步 (S)
        if (cmdShift && e.key.toLowerCase() === 's') { 
            e.preventDefault(); 
            saveCard(); 
        }

        // 導出 (E)
        if (cmdShift && e.key.toLowerCase() === 'e') {
            e.preventDefault();
            exportDraft();
        }

        // 新建工作室項目 (P)
        if (cmdShift && e.key.toLowerCase() === 'p') {
            e.preventDefault();
            if(confirm('Start new studio project?')) { project = { segments: [] }; renderProject(); }
        }

        // 其他功能
        if (cmdShift && e.key.toLowerCase() === 'f') { e.preventDefault(); toggleSearch(); }
        if (cmdShift && e.key.toLowerCase() === 'b') { e.preventDefault(); changeView('board'); }
        if (e.key === 'Escape') { hideSearch(); cancelLink(); }
    });

    // --- 2. Dropbox 404 修復邏輯 ---
    function handleCloud() {
        const dbxAuth = new Dropbox.DropboxAuth({ clientId: CLIENT_ID });
        // 核心：移除所有 hash 和參數，只保留純粹的 URL
        const cleanUrl = window.location.origin + window.location.pathname;
        window.location.href = dbxAuth.getAuthenticationUrl(cleanUrl);
    }

    async function syncNow() {
        if(!dbx) return;
        document.getElementById('syncIndicator').innerText = "Syncing...";
        try {
            await dbx.filesUpload({ path: '/vault.json', contents: JSON.stringify(cards), mode: 'overwrite' });
            await dbx.filesUpload({ path: '/studio.json', contents: JSON.stringify(project), mode: 'overwrite' });
            document.getElementById('syncIndicator').innerText = "Cloud Synced";
        } catch(e) { document.getElementById('syncIndicator').innerText = "Sync Error"; }
    }

    // --- 3. 核心邏輯 ---
    function changeView(v) {
        document.getElementById('mainBody').className = 'flex flex-col h-screen view-' + v;
        document.getElementById('studioBoardToggle').classList.toggle('hidden', v !== 'studio');
        if(v === 'board' || v === 'studio') renderBoard();
        if(v === 'studio') renderProject();
        if(v === 'input') document.getElementById('mainIn').focus();
    }

    function setType(t) {
        currentType = t;
        document.getElementById('ti').className = t === 'Idea' ? 'px-4 py-1 active-type' : 'px-4 py-1';
        document.getElementById('tq').className = t === '摘錄' ? 'px-4 py-1 active-type' : 'px-4 py-1';
    }

    function saveCard() {
        const val = document.getElementById('mainIn').value.trim();
        if(!val) return;
        const id = (Math.floor(Date.now() / 1000) % 0xFFFF).toString(16).toUpperCase().padStart(4, '0');
        const tags = (val.match(/#([^\s#]+)/g) || []).map(t => t.substring(1));
        cards.unshift({ id, content: val, mode: currentType, time: Date.now(), tags });
        document.getElementById('mainIn').value = "";
        saveData();
        updateStats();
        if(dbx) syncNow();
    }

    function exportDraft() {
        const name = document.getElementById('projName').value;
        let content = `# ${name}\n\n`;
        project.segments.forEach(seg => {
            if(seg.type === 'card') content += `\n> ${cards.find(x => x.id === seg.id).content}\n\n`;
            else content += seg.content + "\n";
        });
        const blob = new Blob([content], {type: 'text/markdown'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `${name}.md`; a.click();
    }

    // --- 4. 界面渲染 ---
    function renderBoard(filter, customList) {
        const grid = document.getElementById('boardGrid');
        let list = customList || (filter ? cards.filter(c => c.mode === filter || c.tags.includes(filter)) : cards);
        grid.innerHTML = list.map(c => `
            <div class="board-card p-5" onclick="${linkSourceId ? `finishLink('${c.id}')` : ''}">
                <div class="flex justify-between items-center text-[10px] font-black border-b border-black pb-2 mb-3">
                    <span class="mono">#${c.id}</span>
                    <button onclick="startLink('${c.id}', event)" class="hover:bg-blue-600 hover:text-white border border-black px-1 uppercase">Link</button>
                    <input type="checkbox" class="card-sel" value="${c.id}" onclick="event.stopPropagation()">
                </div>
                <div class="flex-1 text-sm overflow-y-auto no-scrollbar">${marked.parse(c.content)}</div>
            </div>`).join('');
    }

    function renderProject() {
        document.getElementById('studioCanvas').innerHTML = project.segments.map((seg, idx) => seg.type === 'card' ? 
            `<div class="p-6 bg-zinc-50 border-l-[12px] border-black text-sm italic shadow-sm relative group"><div class="mb-2 mono font-black text-blue-600 text-[10px]">[[${seg.id}]]</div>${marked.parse(cards.find(x => x.id === seg.id).content)}</div>` : 
            `<textarea oninput="project.segments[${idx}].content=this.value; saveData();" class="w-full min-h-[120px] text-lg outline-none bg-transparent border-b-2 border-zinc-100 focus:border-black py-4 leading-relaxed" placeholder="Develop thought...">${seg.content}</textarea>`).join('');
    }

    // --- 5. 搜索與統計 ---
    function toggleSearch() {
        const bar = document.getElementById('searchBar');
        bar.classList.toggle('active');
        if(bar.classList.contains('active')) document.getElementById('searchInput').focus();
    }
    function hideSearch() { document.getElementById('searchBar').classList.remove('active'); }
    
    document.getElementById('searchInput').addEventListener('input', e => {
        const term = e.target.value.toLowerCase();
        const res = cards.filter(c => c.content.toLowerCase().includes(term) || c.tags.some(t => t.includes(term)));
        renderBoard(null, res);
    });

    function updateStats() {
        document.getElementById('c-i').innerText = cards.filter(c => c.mode === 'Idea').length;
        document.getElementById('c-q').innerText = cards.filter(c => c.mode === '摘錄').length;
        const tags = {}; cards.forEach(c => c.tags.forEach(t => tags[t] = (tags[t]||0)+1));
        document.getElementById('tagBox').innerHTML = Object.entries(tags).map(([k,v]) => `<div class="p-3 text-[11px] font-bold border-b hover:bg-black hover:text-white cursor-pointer flex justify-between" onclick="filterBoard('${k}')"><span>#${k}</span><span class="opacity-30">${v}</span></div>`).join('');
    }

    function startLink(id, e) { e.stopPropagation(); linkSourceId = id; document.body.classList.add('linking-mode'); changeView('board'); }
    function finishLink(id) { if(linkSourceId && linkSourceId !== id) { const t = cards.find(x => x.id === id); t.content += `\n\nRelated: [[${linkSourceId}]]`; saveData(); } cancelLink(); }
    function cancelLink() { linkSourceId = null; document.body.classList.remove('linking-mode'); renderBoard(); }
    function saveData() { localStorage.setItem('Z_V14_Cards', JSON.stringify(cards)); localStorage.setItem('Z_V14_Proj', JSON.stringify(project)); }
    function toggleStudioBoard() { document.getElementById('mainBody').classList.toggle('show-board'); }

    // 初始化授權識別
    window.onload = () => {
        const hash = new URLSearchParams(window.location.hash.substring(1));
        if(hash.get('access_token')) {
            localStorage.setItem('db_tk', hash.get('access_token'));
            window.history.replaceState({}, "", window.location.pathname);
        }
        if(localStorage.getItem('db_tk')) {
            dbx = new Dropbox.Dropbox({ accessToken: localStorage.getItem('db_tk') });
            document.getElementById('cloudBtn').innerText = "Sync Active";
            document.getElementById('cloudBtn').classList.replace('bg-blue-500', 'bg-green-600');
        }
        updateStats();
    };
</script>
</body>
</html>
