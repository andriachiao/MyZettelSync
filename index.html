<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ZettelStudio | Network & Review</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@700&family=Inter:wght@400;900&display=swap');
        body { font-family: 'Inter', sans-serif; background: #f0f0f0; height: 100vh; overflow: hidden; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* Ê®°ÂºèËàá‰ΩàÂ±Ä */
        .studio-active #studioSide { width: 480px; opacity: 1; border-left: 4px solid black; }
        .studio-active #midEditor { display: none !important; }
        .studio-active #midBoard { display: flex !important; }
        .board-view #midEditor { display: none; }
        .board-view #midBoard { display: flex; }
        #midBoard, #studioSide { display: none; }
        #studioSide { width: 0; opacity: 0; overflow: hidden; transition: all 0.2s ease; }

        /* ÁúãÊùøÁ∂≤Ê†º */
        .card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem; align-content: start; }
        .board-card { height: 320px; border: 3px solid #000; padding: 1.2rem; background: #fff; box-shadow: 4px 4px 0 #000; position: relative; transition: 0.1s; }
        .card-content-preview { flex: 1; overflow-y: auto; font-size: 0.85rem; line-height: 1.6; }

        /* ÊèêÈÜíÊ®ôÁ±§ */
        .review-badge { position: absolute; top: -10px; left: 10px; background: #ff4757; color: white; padding: 2px 8px; font-size: 9px; font-weight: 900; box-shadow: 2px 2px 0 #000; }
        .link-tool { cursor: crosshair; }
        
        .z-link { background: #000; color: #fff; padding: 0 4px; font-family: 'JetBrains Mono'; font-size: 10px; border-radius: 2px; cursor: pointer; }
        .active-mode-btn { background: black !important; color: white !important; }
    </style>
</head>
<body id="mainBody" class="flex flex-col h-screen">

    <header class="h-14 border-b-4 border-black flex items-center justify-between px-6 bg-white z-[100]">
        <div class="flex items-center gap-6">
            <h1 class="text-lg font-900 uppercase tracking-tighter italic">ZettelStudio</h1>
            <nav class="flex border-2 border-black divide-x-2 divide-black">
                <button onclick="setUIMode('input')" id="btn-input" class="px-4 py-1 text-[10px] font-black uppercase">Input</button>
                <button onclick="setUIMode('studio')" id="btn-studio" class="px-4 py-1 text-[10px] font-black uppercase">Studio</button>
            </nav>
            <button onclick="toggleMidView()" class="text-[9px] font-black border-l-2 border-black px-4 hover:bg-yellow-400">BOARD (C+B)</button>
        </div>
        <div id="quickNotice" class="text-[10px] font-black text-blue-600 animate-pulse"></div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        
        <aside class="w-60 border-r-4 border-black bg-white flex flex-col shrink-0">
            <div class="p-4 bg-zinc-100 text-[10px] font-black uppercase border-b-2 border-black">Vault Review</div>
            <div class="flex-1 overflow-y-auto no-scrollbar">
                <div class="idx-item border-b border-black/10 p-4 cursor-pointer font-bold text-xs hover:bg-red-500 hover:text-white transition flex justify-between" onclick="filterBoard('review')"><span>ÈúÄË¶ÅË§áÁøí (Spaced)</span><span id="c-r">0</span></div>
                <div class="idx-item border-b border-black/10 p-4 cursor-pointer font-bold text-xs hover:bg-orange-500 hover:text-white transition flex justify-between" onclick="filterBoard('undeveloped')"><span>ÂæÖÁôºÂ±ï (Drafts)</span><span id="c-u">0</span></div>
                <div class="p-3 bg-zinc-50 text-[8px] font-black opacity-40 uppercase mt-4 border-y-2 border-black">Boxes</div>
                <div class="idx-item p-4 cursor-pointer font-bold text-xs hover:bg-black hover:text-white" onclick="filterBoard('ÊëòÈåÑ')">ÊëòÈåÑÁõí</div>
                <div class="idx-item p-4 cursor-pointer font-bold text-xs hover:bg-black hover:text-white border-b-2 border-black" onclick="filterBoard('Idea')">Idea Áõí</div>
                <div id="tagBox"></div>
            </div>
        </aside>

        <main id="midContent" class="flex-1 flex flex-col relative overflow-hidden bg-zinc-100">
            
            <section id="midEditor" class="flex-1 flex flex-col items-center pt-24 px-10">
                <div class="max-w-xl w-full bg-white border-4 border-black p-8 shadow-[12px_12px_0_0_#000]">
                    <textarea id="mainIn" class="w-full h-64 text-xl outline-none leading-relaxed bg-transparent resize-none" placeholder="Ëº∏ÂÖ•ÊÉ≥Ê≥ï... [[ID]]"></textarea>
                    <div class="mt-6 flex justify-between items-center">
                        <span class="text-[9px] font-black opacity-30">TYPE CTRL+S TO SAVE SILENTLY</span>
                        <button onclick="saveCard()" class="bg-black text-white px-10 py-3 font-900 text-xs uppercase hover:bg-zinc-800">Save Card</button>
                    </div>
                </div>
            </section>

            <section id="midBoard" class="flex-1 flex flex-col p-8 overflow-hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 id="boardTitle" class="text-xs font-900 uppercase border-l-4 border-black pl-3">Archives</h2>
                    <div class="flex gap-2">
                        <span id="linkBuffer" class="hidden text-[10px] font-black bg-yellow-400 px-3 py-2 border-2 border-black">LINKING FROM...</span>
                        <button onclick="pushSelected()" class="bg-blue-600 text-white text-[10px] font-black px-6 py-2 uppercase shadow-[4px_4px_0_#000]">Push to Project</button>
                    </div>
                </div>
                <div id="boardGrid" class="flex-1 overflow-y-auto card-grid no-scrollbar pb-10"></div>
            </section>
        </main>

        <aside id="studioSide" class="bg-white flex flex-col overflow-hidden">
            <div class="p-6 border-b-4 border-black bg-zinc-50 space-y-4">
                <input id="projName" class="font-900 text-xl uppercase outline-none bg-transparent border-b-2 border-zinc-200 focus:border-black w-full" value="Untitled Project">
                <button onclick="exportDoc()" class="w-full text-[10px] font-black bg-black text-white py-2">EXPORT .MD</button>
            </div>
            <div id="studioCanvas" class="flex-1 overflow-y-auto p-8 no-scrollbar space-y-6"></div>
        </aside>
    </div>

    <div id="editModal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-[300] flex items-center justify-center p-6">
        <div class="bg-white border-4 border-black p-8 max-w-2xl w-full shadow-[20px_20px_0_0_#000]">
            <div class="flex justify-between mb-4 border-b-2 border-black pb-2">
                <span id="editId" class="font-black mono text-xl">#ID</span>
                <div class="flex gap-4 items-center">
                    <button id="delBtn" class="text-[9px] font-black text-red-500 hover:underline uppercase">Delete Card</button>
                    <button onclick="closeModal()" class="font-black text-[9px] border-2 border-black px-2 uppercase">Close</button>
                </div>
            </div>
            <textarea id="editArea" class="w-full h-80 text-lg outline-none leading-relaxed resize-none bg-zinc-50 p-2"></textarea>
            <div id="backlinks" class="mt-4 flex flex-wrap gap-2 text-[10px] font-black"></div>
            <button onclick="updateCard()" class="mt-4 w-full bg-black text-white py-4 font-900 text-xs uppercase">Save Changes</button>
        </div>
    </div>

<script>
    let cards = JSON.parse(localStorage.getItem('Z_Cards_V7')) || [];
    let project = JSON.parse(localStorage.getItem('Z_Proj_V7')) || { segments: [] };
    let currentInputMode = 'Idea';
    let linkSourceId = null;
    let editingId = null;

    // ÈñìÈöîÈáçË§áÈÄ±Êúü (Áßí)
    const INTERVALS = { week: 604800, month: 2592000, month3: 7776000, year: 31536000 };

    window.addEventListener('keydown', e => {
        const ctrl = e.ctrlKey || e.metaKey;
        if (ctrl && e.key === '1') { e.preventDefault(); currentInputMode='ÊëòÈåÑ'; setUIMode('input'); }
        if (ctrl && e.key === '2') { e.preventDefault(); currentInputMode='Idea'; setUIMode('input'); }
        if (ctrl && e.key === '3') { e.preventDefault(); setUIMode('studio'); }
        if (ctrl && e.key === 'b') { e.preventDefault(); toggleMidView(); }
        if (ctrl && e.key === 's') { e.preventDefault(); saveCard(); }
    });

    window.onload = () => { updateStats(); setUIMode('input'); checkReviewCount(); };

    function setUIMode(mode) {
        document.getElementById('mainBody').classList.toggle('studio-active', mode === 'studio');
        if(mode === 'studio') { document.getElementById('studioSide').style.display = 'flex'; renderBoard(); renderProject(); }
        else { setMidView('editor'); }
    }

    function toggleMidView() {
        if(document.body.classList.contains('studio-active')) return;
        const content = document.getElementById('midContent');
        content.classList.toggle('board-view');
        if(content.classList.contains('board-view')) renderBoard();
    }

    function setMidView(view) {
        document.getElementById('midContent').classList.toggle('board-view', view === 'board');
        if(view === 'board') renderBoard();
    }

    function saveCard() {
        const content = document.getElementById('mainIn').value.trim();
        if(!content) return;
        const id = (Math.floor(Date.now() / 1000) % 0xFFFF).toString(16).toUpperCase().padStart(4, '0');
        cards.unshift({ id, content, mode: currentInputMode, time: Date.now(), tags: (content.match(/#[^\s]+/g) || []).map(t => t.substring(1)) });
        localStorage.setItem('Z_Cards_V7', JSON.stringify(cards));
        document.getElementById('mainIn').value = "";
        updateStats(); document.getElementById('mainIn').focus();
    }

    function updateStats() {
        const now = Date.now() / 1000;
        const reviewList = cards.filter(c => {
            const age = now - (c.time / 1000);
            return Object.values(INTERVALS).some(int => Math.abs(age - int) < 86400); // 1Â§©Ë™§Â∑ÆÂÖßÊèêÈÜí
        });
        const undevel = cards.filter(c => c.content.length < 30 && c.tags.length === 0);
        
        document.getElementById('c-r').innerText = reviewList.length;
        document.getElementById('c-u').innerText = undevel.length;
        document.getElementById('c-q').innerText = cards.filter(c => c.mode === 'ÊëòÈåÑ').length;
        document.getElementById('c-i').innerText = cards.filter(c => c.mode === 'Idea').length;
    }

    function filterBoard(type) {
        setMidView('board');
        if(type === 'review') {
            const now = Date.now() / 1000;
            renderBoard(null, cards.filter(c => Object.values(INTERVALS).some(int => Math.abs((now - c.time/1000) - int) < 86400)));
        } else if(type === 'undeveloped') {
            renderBoard(null, cards.filter(c => c.content.length < 30 && c.tags.length === 0));
        } else {
            renderBoard(type);
        }
    }

    function renderBoard(filter, customList) {
        const grid = document.getElementById('boardGrid');
        let list = customList || (filter ? cards.filter(c => c.tags.includes(filter) || c.mode === filter) : cards);
        const now = Date.now() / 1000;

        grid.innerHTML = list.map(c => {
            const age = now - (c.time / 1000);
            let badge = "";
            if (Math.abs(age - INTERVALS.week) < 86400) badge = "1 WEEK REVIEW";
            if (Math.abs(age - INTERVALS.month) < 86400) badge = "1 MONTH REVIEW";
            
            return `
            <div class="board-card flex flex-col">
                ${badge ? `<div class="review-badge">${badge}</div>` : ''}
                <div class="flex justify-between items-start mb-3 border-b-2 border-black pb-1">
                    <span class="mono font-black text-xs">#${c.id}</span>
                    <div class="flex gap-2">
                        <button onclick="startLink('${c.id}')" class="text-[8px] font-black border border-black px-1 hover:bg-yellow-400">LINK</button>
                        <button onclick="openEdit('${c.id}')" class="text-[8px] font-black border border-black px-1 hover:bg-black hover:text-white">EDIT</button>
                    </div>
                </div>
                <div class="card-content-preview flex-1">${marked.parse(c.content).replace(/\[\[([A-Z0-9]{4})\]\]/g, '<span class="z-link" onclick="event.stopPropagation(); openEdit(\'$1\')">[[$1]]</span>')}</div>
                <div class="mt-2 pt-2 border-t border-zinc-100 flex justify-between">
                    <input type="checkbox" class="card-checkbox" value="${c.id}">
                    <span class="text-[8px] opacity-30 font-black">${new Date(c.time).toLocaleDateString()}</span>
                </div>
            </div>`;
        }).join('');
    }

    function startLink(id) {
        if(!linkSourceId) {
            linkSourceId = id;
            document.getElementById('linkBuffer').innerText = `LINKING FROM #${id}... (Click another Link)`;
            document.getElementById('linkBuffer').classList.remove('hidden');
        } else {
            if(linkSourceId === id) { linkSourceId = null; document.getElementById('linkBuffer').classList.add('hidden'); return; }
            const target = cards.find(x => x.id === id);
            target.content += `\n\nRelated: [[${linkSourceId}]]`;
            localStorage.setItem('Z_Cards_V7', JSON.stringify(cards));
            linkSourceId = null;
            document.getElementById('linkBuffer').classList.add('hidden');
            renderBoard();
        }
    }

    function openEdit(id) {
        editingId = id;
        const c = cards.find(x => x.id === id);
        document.getElementById('editId').innerText = `#${id}`;
        document.getElementById('editArea').value = c.content;
        document.getElementById('delBtn').onclick = () => deleteCard(id);
        document.getElementById('editModal').classList.remove('hidden');
    }

    function updateCard() {
        const c = cards.find(x => x.id === editingId);
        c.content = document.getElementById('editArea').value;
        c.tags = (c.content.match(/#[^\s]+/g) || []).map(t => t.substring(1));
        localStorage.setItem('Z_Cards_V7', JSON.stringify(cards));
        closeModal(); renderBoard(); updateStats();
    }

    function deleteCard(id) {
        if(confirm('Delete permanently?')) {
            cards = cards.filter(x => x.id !== id);
            localStorage.setItem('Z_Cards_V7', JSON.stringify(cards));
            closeModal(); renderBoard(); updateStats();
        }
    }

    function closeModal() { document.getElementById('editModal').classList.add('hidden'); }
    function checkReviewCount() {
        const count = document.getElementById('c-r').innerText;
        if(count > 0) document.getElementById('quickNotice').innerText = `üîî ${count} CARDS NEED REVIEW`;
    }

    // È†ÖÁõÆÊé®Êí≠ËàáÂ∞éÂá∫ÈÇèËºØ‰øùÊåÅ‰∏çËÆä...
    function pushSelected() {
        const checked = document.querySelectorAll('.card-checkbox:checked');
        if(!checked.length) return;
        setUIMode('studio');
        checked.forEach(cb => {
            project.segments.push({ type: 'card', id: cb.value });
            project.segments.push({ type: 'text', content: '' });
        });
        saveProject(); renderProject();
        checked.forEach(cb => cb.checked = false);
    }

    function renderProject() {
        document.getElementById('studioCanvas').innerHTML = project.segments.map((seg, idx) => {
            if(seg.type === 'card') {
                const c = cards.find(x => x.id === seg.id);
                return `<div class="p-4 bg-zinc-50 border-l-8 border-black text-xs italic relative group">
                    <span class="font-900 mono underline cursor-pointer" onclick="openEdit('${c.id}')">[[${c.id}]]</span> ${c.content.substring(0,80)}...
                    <button onclick="removeSeg(${idx})" class="absolute -right-2 -top-2 bg-red-500 text-white rounded-full w-5 h-5 hidden group-hover:flex items-center justify-center text-xs">√ó</button>
                </div>`;
            } else {
                return `<textarea oninput="project.segments[${idx}].content=this.value;saveProject()" class="w-full min-h-[80px] text-sm outline-none bg-transparent border-b border-zinc-200 focus:border-black py-2" placeholder="Êí∞ÂØ´ÁôºÂ±ïÊÆµËêΩ...">${seg.content}</textarea>`;
            }
        }).join('');
    }
    function saveProject() { localStorage.setItem('Z_Proj_V7', JSON.stringify(project)); }
    function removeSeg(idx) { project.segments.splice(idx, 1); saveProject(); renderProject(); }
    function exportDoc() {
        const name = document.getElementById('projName').value;
        let md = `# ${name}\n\n`;
        project.segments.forEach(s => {
            if(s.type === 'card') md += `\n> ${cards.find(x => x.id === s.id).content}\n\n`;
            else md += s.content + "\n";
        });
        const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([md])); a.download = `${name}.md`; a.click();
    }
</script>
</body>
</html>
