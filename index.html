<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ZET-SYNC PRO | çµ‚æ¥µå¡ç‰‡ç›’</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dropbox.js/10.34.0/Dropbox-sdk.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .wiki-link { color: #4f46e5; font-weight: bold; cursor: pointer; text-decoration: underline; }
        .highlight { background-color: #fef08a; font-weight: bold; }
        .card-entry { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .card-entry:hover { transform: translateY(-2px); box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1); }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        /* éš±è—åŸç”Ÿæ»¾å‹•æ¢ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        /* App æ¨¡å¼é©é… */
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="flex flex-col md:flex-row h-screen overflow-hidden">

    <aside class="w-full md:w-80 bg-white border-r border-slate-200 flex flex-col shadow-lg z-30">
        <div class="p-6">
            <div class="flex justify-between items-center mb-2">
                <h1 class="text-2xl font-900 text-slate-800 tracking-tighter">ZET-SYNC</h1>
                <span id="cloudIndicator" class="text-[10px] bg-slate-100 px-2 py-0.5 rounded-full text-slate-400">OFFLINE</span>
            </div>
            
            <div id="syncPanel" class="mb-6 p-4 bg-slate-50 rounded-2xl border border-slate-100">
                <div class="text-[11px] font-bold text-slate-500 mb-2 uppercase flex justify-between">
                    <span>Dropbox Sync</span>
                    <button onclick="authDropbox()" class="text-blue-500 hover:underline">é€£æ¥</button>
                </div>
                <div id="syncMsg" class="text-[10px] text-slate-400 italic">å°šæœªé€£çµé›²ç«¯ç©ºé–“</div>
            </div>

            <div class="grid grid-cols-2 gap-2 mb-6">
                <div class="p-2 bg-indigo-50 rounded-lg border border-indigo-100 text-center">
                    <p class="text-[9px] font-bold text-indigo-400 uppercase">Alt + 1</p>
                    <p class="text-[11px] font-bold text-indigo-600">æ‘˜éŒ„æ¨¡å¼</p>
                </div>
                <div class="p-2 bg-emerald-50 rounded-lg border border-emerald-100 text-center">
                    <p class="text-[9px] font-bold text-emerald-400 uppercase">Alt + 2</p>
                    <p class="text-[11px] font-bold text-emerald-600">éˆæ„Ÿæ¨¡å¼</p>
                </div>
            </div>

            <h3 class="text-[10px] font-black text-slate-400 mb-3 uppercase tracking-widest">Hot Keywords</h3>
            <div id="keywordCloud" class="flex flex-wrap gap-2 mb-6"></div>
        </div>

        <div class="flex-1 overflow-y-auto px-6 custom-scrollbar">
            <h3 class="text-[10px] font-black text-slate-400 mb-3 uppercase tracking-widest">All Tags</h3>
            <div id="tagList" class="space-y-1 pb-10"></div>
        </div>

        <div class="p-6 border-t border-slate-100 bg-slate-50">
            <div class="grid grid-cols-2 gap-2">
                <button onclick="exportToObsidian()" class="text-[11px] font-bold py-2 bg-white border border-slate-200 rounded-lg hover:bg-slate-100">OBSIDIAN</button>
                <button onclick="exportToCSV()" class="text-[11px] font-bold py-2 bg-white border border-slate-200 rounded-lg hover:bg-slate-100">NOTION(CSV)</button>
            </div>
        </div>
    </aside>

    <main class="flex-1 overflow-y-auto no-scrollbar relative">
        <div class="max-w-4xl mx-auto p-4 md:p-12">
            
            <div class="mb-8 relative">
                <i class="fa-solid fa-magnifying-glass absolute left-4 top-1/2 -translate-y-1/2 text-slate-300"></i>
                <input type="text" id="searchInput" oninput="renderCards()" placeholder="æœå°‹é—œéµè©ã€ID æˆ–æ¨™ç±¤..." 
                    class="w-full pl-12 pr-4 py-4 bg-white rounded-2xl shadow-sm border border-slate-100 outline-none focus:ring-2 focus:ring-indigo-400 transition-all">
            </div>

            <div id="dropZone" class="bg-white rounded-3xl shadow-xl border border-slate-100 overflow-hidden mb-12">
                <div class="px-6 py-4 bg-slate-50 border-b border-slate-100 flex justify-between items-center">
                    <div id="entryBadge" class="text-[10px] font-black bg-slate-200 text-slate-500 px-3 py-1 rounded-full uppercase">æ¨™æº–ç­†è¨˜</div>
                    <input type="text" id="keywordInput" placeholder="è¼¸å…¥é—œéµè© (é€—è™Ÿéš”é–‹)..." class="bg-transparent border-none focus:ring-0 text-sm font-bold text-slate-600 w-1/2 text-right">
                </div>
                <div class="p-6">
                    <textarea id="cardInput" class="w-full text-xl border-none focus:ring-0 outline-none text-slate-800 placeholder-slate-300 min-h-[120px]" 
                        placeholder="ç¾åœ¨åœ¨æƒ³ä»€éº¼ï¼Ÿä½¿ç”¨ -æ¨™ç±¤ åˆ†é¡..."></textarea>
                    <div id="imagePreview" class="flex flex-wrap gap-2 mt-4"></div>
                </div>
                <div class="px-6 py-4 bg-white border-t border-slate-50 flex justify-between items-center">
                    <div class="text-[10px] text-slate-400 font-mono">CTRL + ENTER TO SAVE</div>
                    <button onclick="saveCard()" class="px-8 py-3 bg-slate-900 text-white rounded-2xl font-black hover:bg-indigo-600 transition-colors shadow-lg shadow-slate-200">å„²å­˜å¡ç‰‡</button>
                </div>
            </div>

            <div id="cardList" class="space-y-6 pb-32"></div>
        </div>
    </main>

    <div id="modal" class="hidden fixed inset-0 bg-slate-900/40 backdrop-blur-md flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-[40px] max-w-6xl w-full flex flex-col md:flex-row shadow-2xl overflow-hidden max-h-[90vh]">
            <div class="flex-1 p-8 md:p-16 overflow-y-auto border-r border-slate-100">
                <div id="modalHeader" class="mb-10"></div>
                <div id="modalContent" class="prose prose-slate max-w-none text-slate-700"></div>
                <div id="modalImages" class="mt-8 space-y-4"></div>
                <div class="mt-12 pt-8 border-t flex gap-4">
                    <button onclick="updateStatus('developing')" class="text-xs font-black text-blue-500">ğŸŒ¿ ç™¼å±•</button>
                    <button onclick="updateStatus('archived')" class="text-xs font-black text-slate-400">ğŸ“¦ æ­¸æª”</button>
                    <button onclick="deleteCard()" class="ml-auto text-xs font-black text-red-300">åˆªé™¤</button>
                </div>
            </div>
            <div class="w-full md:w-[400px] bg-slate-50 p-8 flex flex-col">
                <canvas id="networkCanvas" width="350" height="350" class="w-full rounded-3xl bg-white border shadow-inner"></canvas>
                <div id="backlinks" class="mt-8 flex-1 overflow-y-auto">
                    <h4 class="text-[10px] font-black text-slate-400 uppercase mb-4 tracking-widest">Backlinks</h4>
                    <div id="backlinksList" class="space-y-2"></div>
                </div>
                <button onclick="closeModal()" class="mt-8 py-4 bg-slate-900 text-white rounded-2xl font-black">CLOSE</button>
            </div>
        </div>
    </div>

<script>
    // --- 1. é…ç½®èˆ‡åˆå§‹åŒ– ---
    const DBX_APP_KEY = 'r8nisc7hr8cta77'; // è«‹å¡«å…¥ä½ çš„ Dropbox App Key
    let cards = JSON.parse(localStorage.getItem('zet_cards')) || [];
    let db, dbx, pendingImages = [], currentEntryType = 'ä¸€èˆ¬';
    let currentFilterTag = null;

    // åˆå§‹åŒ– IndexedDB (åœ–ç‰‡å­˜å„²)
    const dbReq = indexedDB.open("ZetImages", 1);
    dbReq.onupgradeneeded = e => e.target.result.createObjectStore("images", { keyPath: "id" });
    dbReq.onsuccess = e => { db = e.target.result; updateUI(); };

    window.onload = () => {
        initDropbox();
        initShortcuts();
        initDragAndDrop();
        document.getElementById('cardInput').focus();
    };

    // --- 2. é›²ç«¯åŒæ­¥é‚è¼¯ ---
    function initDropbox() {
        const token = new URLSearchParams(window.location.hash.substring(1)).get('access_token');
        if (token) {
            dbx = new Dropbox.Dropbox({ accessToken: token });
            document.getElementById('cloudIndicator').innerText = "ONLINE";
            document.getElementById('cloudIndicator').className = "text-[10px] bg-green-100 px-2 py-0.5 rounded-full text-green-600";
            document.getElementById('syncMsg').innerText = "é›²ç«¯åŒæ­¥å·²é–‹å•Ÿ";
            downloadFromCloud();
        }
    }

    function authDropbox() {
        const url = `https://www.dropbox.com/oauth2/authorize?client_id=${DBX_APP_KEY}&response_type=token&redirect_uri=${encodeURIComponent(window.location.href.split('#')[0])}`;
        window.location.href = url;
    }

    async function uploadToCloud() {
        if (!dbx) return;
        try {
            await dbx.filesUpload({ path: '/zet_data.json', contents: JSON.stringify(cards), mode: 'overwrite' });
            console.log("Cloud synced");
        } catch (e) { console.error(e); }
    }

    async function downloadFromCloud() {
        if (!dbx) return;
        try {
            const res = await dbx.filesDownload({ path: '/zet_data.json' });
            const reader = new FileReader();
            reader.onload = () => { cards = JSON.parse(reader.result); saveAndRefresh(false); };
            reader.readAsText(res.result.fileBlob);
        } catch (e) { console.log("First time sync"); }
    }

    // --- 3. å¿«æ·éµèˆ‡è¼¸å…¥é‚è¼¯ ---
    function initShortcuts() {
        document.addEventListener('keydown', e => {
            if (e.altKey && e.key === '1') setEntryType('æ‘˜éŒ„', 'bg-indigo-600', 'indigo');
            if (e.altKey && e.key === '2') setEntryType('Idea', 'bg-emerald-600', 'emerald');
            if (e.ctrlKey && e.key === 'Enter') saveCard();
        });
    }

    function setEntryType(type, colorClass, colorName) {
        currentEntryType = type;
        const badge = document.getElementById('entryBadge');
        badge.innerText = type + " æ¨¡å¼";
        badge.className = `text-[10px] font-black text-white px-3 py-1 rounded-full uppercase ${colorClass}`;
        const input = document.getElementById('cardInput');
        if (!input.value.includes(`-${type}`)) input.value += ` -${type} `;
        input.focus();
    }

    function initDragAndDrop() {
        const zone = document.getElementById('dropZone');
        zone.ondrop = e => {
            e.preventDefault();
            Array.from(e.dataTransfer.files).forEach(file => {
                if (file.type.startsWith("image/")) {
                    const reader = new FileReader();
                    reader.onload = ev => {
                        const id = "img_" + Date.now();
                        pendingImages.push({ id, data: ev.target.result });
                        renderPendingImages();
                    };
                    reader.readAsDataURL(file);
                }
            });
        };
        zone.ondragover = e => e.preventDefault();
    }

    function renderPendingImages() {
        document.getElementById('imagePreview').innerHTML = pendingImages.map(img => `
            <img src="${img.data}" class="h-12 w-12 rounded-lg object-cover shadow-sm">
        `).join('');
    }

    // --- 4. æ ¸å¿ƒæ•¸æ“šè™•ç† ---
    async function saveCard() {
        const input = document.getElementById('cardInput');
        const kwInput = document.getElementById('keywordInput');
        const text = input.value.trim();
        if (!text && pendingImages.length === 0) return;

        const tags = (text.match(/-[^\s]+/g) || []).map(t => t.substring(1));
        const kws = kwInput.value.split(',').map(k => k.trim()).filter(k => k);
        const cardId = Math.random().toString(36).substr(2, 6).toUpperCase();

        const newCard = {
            id: cardId, fullId: Date.now(), content: text,
            tags: tags.length ? tags : ["æœªåˆ†é¡"],
            keywords: kws, time: Date.now(), status: 'draft',
            images: pendingImages.map(i => i.id)
        };

        // å­˜åœ–ç‰‡åˆ° IndexedDB
        if (pendingImages.length > 0) {
            const tx = db.transaction("images", "readwrite");
            pendingImages.forEach(img => tx.objectStore("images").put(img));
        }

        cards.unshift(newCard);
        pendingImages = [];
        input.value = "";
        kwInput.value = "";
        document.getElementById('imagePreview').innerHTML = "";
        saveAndRefresh();
        if (dbx) uploadToCloud();
    }

    function saveAndRefresh(shouldCloud = true) {
        localStorage.setItem('zet_cards', JSON.stringify(cards));
        updateUI();
    }

    async function updateUI() {
        renderTags();
        renderKeywords();
        await renderCards();
    }

    async function renderCards() {
        const term = document.getElementById('searchInput').value.toLowerCase();
        const list = document.getElementById('cardList');
        
        let filtered = cards.filter(c => 
            (currentFilterTag ? c.tags.includes(currentFilterTag) : true) &&
            (term === "" || c.content.toLowerCase().includes(term) || (c.keywords && c.keywords.some(k => k.toLowerCase().includes(term))))
        );

        let html = "";
        for (let c of filtered) {
            let contentHtml = marked.parse(c.content.replace(/-[^\s]+/g, ''));
            if (term) contentHtml = contentHtml.replace(new RegExp(`(${term})`, 'gi'), '<mark class="highlight">$1</mark>');

            let firstImg = "";
            if (c.images && c.images.length > 0) {
                const img = await getImg(c.images[0]);
                if (img) firstImg = `<img src="${img.data}" class="w-full h-48 object-cover rounded-2xl mb-4">`;
            }

            html += `
                <div onclick="showCardDetail('${c.fullId}')" class="card-entry bg-white p-8 rounded-[32px] border border-slate-100 cursor-pointer">
                    <div class="flex justify-between items-start mb-6">
                        <div class="flex flex-wrap gap-2">
                            ${c.keywords ? c.keywords.map(k => `<span class="bg-amber-100 text-amber-700 text-[10px] font-900 px-2 py-0.5 rounded-lg"># ${k}</span>`).join('') : ''}
                        </div>
                        <span class="text-[10px] font-mono text-slate-300 tracking-tighter">${c.id}</span>
                    </div>
                    ${firstImg}
                    <div class="prose prose-slate mb-6 line-clamp-4">${contentHtml}</div>
                    <div class="flex gap-3">
                        ${c.tags.map(t => `<span class="text-indigo-500 text-[10px] font-bold uppercase tracking-widest">@${t}</span>`).join('')}
                    </div>
                </div>
            `;
        }
        list.innerHTML = html || `<div class="text-center py-20 text-slate-300 italic font-bold">æ²’æœ‰æ‰¾åˆ°åŒ¹é…çš„å¡ç‰‡</div>`;
    }

    async function getImg(id) {
        return new Promise(resolve => {
            const req = db.transaction("images").objectStore("images").get(id);
            req.onsuccess = () => resolve(req.result);
        });
    }

    // --- 5. å°å‡ºåŠŸèƒ½ ---
    async function exportToObsidian() {
        const zip = new JSZip();
        for (let c of cards) {
            let md = `---\nid: ${c.id}\ntags: ${c.tags.join(', ')}\nkeywords: ${c.keywords ? c.keywords.join(', ') : ''}\n---\n\n${c.content}`;
            zip.file(`${c.id}.md`, md);
        }
        const blob = await zip.generateAsync({type:"blob"});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `ZetSync_Obsidian.zip`;
        a.click();
    }

    // å…¶ä»– UI æ§åˆ¶å‡½å¼...
    function renderTags() {
        const counts = {};
        cards.forEach(c => c.tags.forEach(t => counts[t] = (counts[t] || 0) + 1));
        document.getElementById('tagList').innerHTML = Object.entries(counts).map(([t, c]) => `
            <div onclick="currentFilterTag='${t}'; updateUI();" class="flex justify-between p-3 rounded-2xl cursor-pointer ${currentFilterTag===t?'bg-indigo-600 text-white shadow-lg shadow-indigo-200':'hover:bg-slate-100 text-slate-600'}">
                <span class="text-sm font-bold">@ ${t}</span><span class="opacity-40 text-xs">${c}</span>
            </div>
        `).join('');
    }

    function renderKeywords() {
        const kCounts = {};
        cards.forEach(c => c.keywords?.forEach(k => kCounts[k] = (kCounts[k] || 0) + 1));
        document.getElementById('keywordCloud').innerHTML = Object.entries(kCounts).slice(0, 10).map(([k, v]) => `
            <span class="bg-slate-100 text-slate-500 text-[10px] px-2 py-1 rounded-lg font-bold">#${k}</span>
        `).join('');
    }

    async function showCardDetail(fid) {
        const card = cards.find(c => c.fullId == fid);
        editingCardId = fid;
        document.getElementById('modalHeader').innerHTML = `<h3 class="text-xs font-black text-indigo-500 tracking-widest uppercase">Card ${card.id} / ${new Date(card.time).toLocaleDateString()}</h3>`;
        document.getElementById('modalContent').innerHTML = marked.parse(card.content).replace(/\[\[([A-Z0-9]+)\]\]/g, '<span class="wiki-link" onclick="jumpTo(\'$1\')">[[$1]]</span>');
        
        const imgContainer = document.getElementById('modalImages');
        imgContainer.innerHTML = "";
        if (card.images) {
            for (let id of card.images) {
                const img = await getImg(id);
                if (img) imgContainer.innerHTML += `<img src="${img.data}" class="w-full rounded-[32px] shadow-2xl mb-6">`;
            }
        }
        document.getElementById('modal').classList.remove('hidden');
    }

    function closeModal() { document.getElementById('modal').classList.add('hidden'); }
    function jumpTo(id) { const c = cards.find(x => x.id === id); if(c) showCardDetail(c.fullId); }
    document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });
</script>
</body>
</html>
