<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ZettelStudio | Final Workspace</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@700&family=Inter:wght@400;900&display=swap');
        body { font-family: 'Inter', sans-serif; background: #f0f0f0; height: 100vh; overflow: hidden; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        /* 佈局切換動畫 */
        .sidebar-transition { transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .studio-active #midEditor { display: none; }
        .studio-active #midBoard { display: flex; }
        .studio-active #studioSide { width: 450px; opacity: 1; border-left: 4px solid black; }
        
        /* 預設隱藏看板與工坊側欄 */
        #midBoard { display: none; }
        #studioSide { width: 0; opacity: 0; overflow: hidden; }
        
        .idx-item { border-bottom: 2px solid #000; cursor: pointer; padding: 10px 15px; font-size: 11px; font-weight: 700; background: #fff; }
        .idx-item:hover { background: #000; color: #fff; }
        .board-card { border: 3px solid #000; padding: 1rem; background: #fff; box-shadow: 4px 4px 0 #000; position: relative; }
        .card-checkbox { position: absolute; top: 10px; right: 10px; transform: scale(1.5); accent-color: #000; cursor: pointer; }
    </style>
</head>
<body id="mainBody" class="flex flex-col h-screen">

    <header class="h-14 border-b-4 border-black flex items-center justify-between px-6 bg-white z-[100]">
        <div class="flex items-center gap-6">
            <h1 class="text-lg font-900 uppercase tracking-tighter">ZettelStudio</h1>
            <nav class="flex border-2 border-black">
                <button onclick="setUIMode('input')" id="btnInput" class="px-4 py-1 text-[10px] font-black bg-black text-white">INPUT MODE</button>
                <button onclick="setUIMode('studio')" id="btnStudio" class="px-4 py-1 text-[10px] font-black hover:bg-yellow-400">STUDIO MODE</button>
            </nav>
        </div>
        <div class="flex gap-4">
            <span id="syncStatus" class="text-[10px] font-black opacity-20 uppercase">Local Sync OK</span>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        
        <aside class="w-64 border-r-4 border-black bg-zinc-50 flex flex-col shrink-0">
            <div class="p-4 bg-zinc-100 text-[10px] font-black uppercase border-b-2 border-black">Boxes Navigator</div>
            <div class="flex-1 overflow-y-auto no-scrollbar">
                <div class="idx-item flex justify-between" onclick="filterBoard('摘錄')"><span>摘錄盒 (Quote)</span><span id="c-q">0</span></div>
                <div class="idx-item flex justify-between" onclick="filterBoard('Idea')"><span>Idea 盒 (Thought)</span><span id="c-i">0</span></div>
                <div class="p-3 bg-zinc-200 text-[8px] font-black uppercase border-b-2 border-black mt-4">Keywords</div>
                <div id="tagBox"></div>
            </div>
        </aside>

        <main class="flex-1 flex flex-col relative overflow-hidden bg-zinc-100">
            <section id="midEditor" class="flex-1 flex flex-col items-center pt-24 px-10">
                <div class="max-w-xl w-full bg-white border-4 border-black p-8 shadow-[12px_12px_0_0_#000]">
                    <div class="flex justify-between items-center mb-4 border-b-2 border-black pb-2">
                        <span class="mono font-black text-xl">#CAPTURE</span>
                        <div class="flex gap-2">
                            <button onclick="setInputMode('摘錄')" id="m-q" class="text-[9px] font-black border border-black px-2">QUOTE</button>
                            <button onclick="setInputMode('Idea')" id="m-i" class="text-[9px] font-black border border-black px-2">IDEA</button>
                        </div>
                    </div>
                    <textarea id="mainIn" class="w-full h-64 text-xl outline-none leading-relaxed bg-transparent resize-none" placeholder="輸入新的原子思考..."></textarea>
                    <button onclick="saveCard()" class="mt-6 w-full bg-black text-white py-4 font-900 text-xs uppercase tracking-widest hover:invert transition">Save to Box</button>
                </div>
            </section>

            <section id="midBoard" class="flex-1 flex flex-col p-6">
                <div class="flex justify-between items-center mb-4 border-b-2 border-black pb-2">
                    <h2 class="text-xs font-900 uppercase">Board Archive</h2>
                    <button onclick="pushSelected()" class="bg-blue-600 text-white text-[10px] font-black px-4 py-1 uppercase">Push Selected to Project</button>
                </div>
                <div id="boardGrid" class="flex-1 overflow-y-auto grid grid-cols-1 md:grid-cols-2 gap-4 no-scrollbar pb-10">
                    </div>
            </section>
        </main>

        <aside id="studioSide" class="bg-white flex flex-col sidebar-transition">
            <div class="p-5 border-b-4 border-black bg-zinc-50 space-y-4">
                <div class="flex justify-between items-center">
                    <input id="projName" class="font-900 text-lg uppercase outline-none bg-transparent border-b-2 border-zinc-200 focus:border-black w-2/3" value="New Project">
                    <select id="projType" class="text-[10px] font-black border-2 border-black px-2 py-1">
                        <option>論文 (Paper)</option>
                        <option>小說 (Novel)</option>
                        <option>劇本 (Script)</option>
                    </select>
                </div>
                <div class="flex justify-between">
                    <button onclick="exportDoc()" class="text-[10px] font-black bg-black text-white px-4 py-1">EXPORT DOC</button>
                    <button onclick="clearProject()" class="text-[10px] font-black text-red-500 underline">CLEAR ALL</button>
                </div>
            </div>
            <div id="studioCanvas" class="flex-1 overflow-y-auto p-8 no-scrollbar space-y-6">
                </div>
        </aside>

    </div>

<script>
    let cards = JSON.parse(localStorage.getItem('Z_Cards_V2')) || [];
    let project = JSON.parse(localStorage.getItem('Z_Project_Active')) || { segments: [] };
    let activeInputMode = 'Idea';

    window.onload = () => {
        updateUI();
        setInputMode('Idea');
    };

    function setUIMode(mode) {
        const body = document.getElementById('mainBody');
        const btnI = document.getElementById('btnInput');
        const btnS = document.getElementById('btnStudio');

        if(mode === 'studio') {
            body.classList.add('studio-active');
            btnS.classList.add('bg-black', 'text-white');
            btnI.classList.remove('bg-black', 'text-white');
            renderBoard();
            renderProject();
        } else {
            body.classList.remove('studio-active');
            btnI.classList.add('bg-black', 'text-white');
            btnS.classList.remove('bg-black', 'text-white');
        }
    }

    function setInputMode(m) {
        activeInputMode = m;
        document.getElementById('m-q').className = m === '摘錄' ? 'text-[9px] font-black bg-black text-white px-2' : 'text-[9px] font-black border border-black px-2';
        document.getElementById('m-i').className = m === 'Idea' ? 'text-[9px] font-black bg-black text-white px-2' : 'text-[9px] font-black border border-black px-2';
    }

    function saveCard() {
        const content = document.getElementById('mainIn').value.trim();
        if(!content) return;
        const id = (Math.floor(Date.now() / 1000) % 0xFFFF).toString(16).toUpperCase().padStart(4, '0');
        cards.unshift({
            id, content, mode: activeInputMode, time: Date.now(),
            tags: (content.match(/#[^\s]+/g) || []).map(t => t.substring(1))
        });
        localStorage.setItem('Z_Cards_V2', JSON.stringify(cards));
        document.getElementById('mainIn').value = "";
        updateUI();
        backupDropbox('Cards');
    }

    function updateUI() {
        document.getElementById('c-q').innerText = cards.filter(c => c.mode === '摘錄').length;
        document.getElementById('c-i').innerText = cards.filter(c => c.mode === 'Idea').length;
        
        const tags = {}; cards.forEach(c => c.tags.forEach(t => tags[t] = (tags[t]||0)+1));
        document.getElementById('tagBox').innerHTML = Object.entries(tags).map(([k,v]) => `
            <div class="idx-item flex justify-between" onclick="setUIMode('studio'); filterBoard('${k}')"><span>#${k}</span><span class="opacity-30">${v}</span></div>
        `).join('');
    }

    function renderBoard(filterTag) {
        let displayCards = filterTag ? cards.filter(c => c.tags.includes(filterTag) || c.mode === filterTag) : cards;
        document.getElementById('boardGrid').innerHTML = displayCards.map(c => `
            <div class="board-card">
                <input type="checkbox" class="card-checkbox" value="${c.id}">
                <div class="text-[9px] font-black uppercase opacity-30 mb-1">${c.mode} #${c.id}</div>
                <div class="text-xs font-bold leading-relaxed">${marked.parse(c.content)}</div>
            </div>
        `).join('');
    }

    function filterBoard(val) {
        renderBoard(val);
    }

    function pushSelected() {
        const checked = document.querySelectorAll('.card-checkbox:checked');
        checked.forEach(cb => {
            project.segments.push({ type: 'card', id: cb.value });
            project.segments.push({ type: 'text', content: '' });
        });
        saveProject();
        renderProject();
        // 取消勾選
        checked.forEach(cb => cb.checked = false);
    }

    function renderProject() {
        const canvas = document.getElementById('studioCanvas');
        canvas.innerHTML = project.segments.map((seg, idx) => {
            if(seg.type === 'card') {
                const c = cards.find(x => x.id === seg.id);
                return `
                    <div class="p-4 bg-zinc-100 border-l-8 border-black text-xs italic relative group">
                        <span class="font-black">[[${c.id}]]</span> ${c.content.substring(0,100)}...
                        <button onclick="removeSeg(${idx})" class="absolute -right-2 -top-2 bg-red-500 text-white rounded-full w-5 h-5 hidden group-hover:flex items-center justify-center text-[10px]">×</button>
                    </div>`;
            } else {
                return `<textarea oninput="updateProjText(${idx}, this.value)" 
                    class="w-full min-h-[100px] text-sm outline-none bg-transparent border-b border-zinc-200 focus:border-black py-2" 
                    placeholder="點擊撰寫發展段落...">${seg.content}</textarea>`;
            }
        }).join('');
    }

    function updateProjText(idx, val) { project.segments[idx].content = val; saveProject(); }
    function removeSeg(idx) { project.segments.splice(idx, 1); saveProject(); renderProject(); }
    function saveProject() { localStorage.setItem('Z_Project_Active', JSON.stringify(project)); backupDropbox('Project'); }
    function clearProject() { if(confirm('確定清空項目？')) { project.segments = []; renderProject(); saveProject(); } }

    function exportDoc() {
        const type = document.getElementById('projType').value;
        const name = document.getElementById('projName').value;
        let md = `# ${type}: ${name}\n\n`;
        project.segments.forEach(s => {
            if(s.type === 'card') md += `\n> ${cards.find(x => x.id === s.id).content}\n\n`;
            else md += s.content + "\n";
        });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([md]));
        a.download = `${type}_${name}.md`;
        a.click();
    }

    function backupDropbox(type) {
        console.log(`Dropbox 備份: Zettel_${type}_Backup.json`);
        // 實際呼叫 Dropbox API 的部分與之前一致，此處簡化
    }
</script>
</body>
</html>
