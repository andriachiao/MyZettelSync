<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ZettelStudio | Manual Backup Mode</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background: #f0f0f0; height: 100vh; display: flex; flex-direction: column; }
        .m-section { display: none; height: 100%; }
        .active { display: flex !important; }
        .z-card { border: 2px solid #000; background: #fff; box-shadow: 4px 4px 0 #000; padding: 15px; margin-bottom: 15px; }
    </style>
</head>
<body>

    <header class="h-14 border-b-2 border-black bg-white flex items-center justify-between px-6 shrink-0">
        <h1 class="font-black italic tracking-tighter">ZETTEL STUDIO (MANUAL)</h1>
        <div class="flex gap-2 text-[10px] font-bold">
            <button onclick="exportData()" class="border-2 border-black px-3 py-1 bg-yellow-400">匯出備份 (Export)</button>
            <button onclick="document.getElementById('file-in').click()" class="border-2 border-black px-3 py-1 bg-blue-400 text-white">匯入備份 (Import)</button>
            <input type="file" id="file-in" class="hidden" onchange="importData(event)">
        </div>
    </header>

    <main class="flex-1 flex overflow-hidden">
        <aside class="w-40 border-r-2 border-black bg-white flex flex-col font-black text-xs uppercase">
            <div class="p-4 border-b hover:bg-black hover:text-white cursor-pointer" onclick="go('in')">Write</div>
            <div class="p-4 border-b hover:bg-black hover:text-white cursor-pointer" onclick="go('bd')">Vault</div>
        </aside>

        <section id="v-in" class="m-section active flex-1 p-10">
            <textarea id="ed" class="w-full h-2/3 text-2xl outline-none bg-transparent resize-none font-medium" placeholder="寫點什麼..."></textarea>
            <div class="mt-4 border-t border-black pt-4">
                <button onclick="save()" class="bg-black text-white px-6 py-2 font-black uppercase">Save to Local</button>
                <p class="text-[10px] mt-2 opacity-50 uppercase font-bold">Note: Remember to Export & Backup frequently!</p>
            </div>
        </section>

        <section id="v-bd" class="m-section flex-1 p-6 overflow-y-auto">
            <div id="grid" class="max-w-2xl mx-auto"></div>
        </section>
    </main>

<script>
    let cards = JSON.parse(localStorage.getItem('Z_MANUAL_DATA') || '[]');

    function go(m) {
        document.querySelectorAll('.m-section').forEach(s => s.classList.remove('active'));
        document.getElementById('v-' + m).classList.add('active');
        if (m === 'bd') render();
    }

    function save() {
        const c = document.getElementById('ed').value.trim();
        if (!c) return;
        cards.unshift({ id: Date.now().toString(36).toUpperCase(), content: c, time: new Date().toLocaleString() });
        localStorage.setItem('Z_MANUAL_DATA', JSON.stringify(cards));
        document.getElementById('ed').value = '';
        alert('已存入瀏覽器本地暫存！');
    }

    function render() {
        document.getElementById('grid').innerHTML = cards.map(c => `
            <div class="z-card">
                <div class="text-[9px] font-black opacity-30 mb-2">#${c.id} - ${c.time}</div>
                <div class="prose prose-sm">${marked.parse(c.content)}</div>
            </div>
        `).join('');
    }

    // 匯出 JSON 檔案
    function exportData() {
        const dataStr = JSON.stringify(cards, null, 2);
        const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `zettel_backup_${new Date().toLocaleDateString()}.json`;
        a.click();
    }

    // 匯入 JSON 檔案
    function importData(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const imported = JSON.parse(e.target.result);
                if (Array.isArray(imported)) {
                    cards = imported;
                    localStorage.setItem('Z_MANUAL_DATA', JSON.stringify(cards));
                    alert('匯入成功！');
                    render();
                }
            } catch (err) { alert('無效的檔案格式'); }
        };
        reader.readAsText(file);
    }

    go('in');
</script>
</body>
</html>
