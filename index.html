<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ZettelStudio PRO | Full Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dropbox.js/10.11.0/Dropbox-sdk.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@700&family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background: #f0f0f0; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        #v-in, #v-bd, #v-st { display: none; height: 100%; }
        .m-in #v-in { display: flex; flex-direction: column; align-items: center; }
        .m-bd #v-bd { display: flex; flex-direction: column; }
        .m-st #v-st { display: flex; }
        .m-st.show-aux #v-bd { display: flex; width: 400px; border-right: 5px solid #000; }
        .z-card { border: 3px solid #000; background: #fff; box-shadow: 8px 8px 0 #000; transition: 0.1s; display: flex; flex-direction: column; height: 320px; }
        .z-card:hover { transform: translate(-3px, -3px); box-shadow: 12px 12px 0 #000; }
        .active-btn { background: #000 !important; color: #fff !important; }
        #toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #000; color: #fff; padding: 10px 20px; border-radius: 5px; opacity: 0; transition: 0.3s; z-index: 9999; }
        .link-mode .z-card { border-color: #2563eb; cursor: crosshair; outline: 4px solid #2563eb; }
    </style>
</head>
<body class="m-in">
    <div id="toast">Ready</div>
    <header class="h-14 border-b-4 border-black bg-white flex items-center justify-between px-6 shrink-0 z-50">
        <div class="flex items-center gap-4">
            <h1 class="text-xl font-900 italic uppercase tracking-tighter">ZettelStudio</h1>
            <div id="link-msg" class="hidden bg-blue-600 text-white text-[10px] px-3 py-1 animate-pulse font-black uppercase">Link Mode: Select Target</div>
        </div>
        <div class="flex gap-2">
            <button id="aux-btn" onclick="document.body.classList.toggle('show-aux')" class="hidden text-[9px] font-black border-2 border-black px-3 py-1 bg-yellow-400">VAULT</button>
            <button id="dbx-btn" onclick="auth()" class="text-[9px] font-black border-2 border-black px-3 py-1 bg-blue-500 text-white">DROPBOX</button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <aside class="w-56 border-r-4 border-black bg-white flex flex-col shrink-0">
            <div class="p-4 border-b-2 border-black font-black text-xs hover:bg-black hover:text-white cursor-pointer" onclick="go('in')">CAPTURE [C+S+M]</div>
            <div class="p-4 border-b-2 border-black font-black text-xs hover:bg-black hover:text-white cursor-pointer" onclick="go('bd')">VAULT [C+S+B]</div>
            <div class="p-4 border-b-2 border-black font-black text-xs hover:bg-black hover:text-white cursor-pointer" onclick="go('st')">STUDIO [C+S+M]</div>
            <div id="tag-box" class="flex-1 overflow-y-auto no-scrollbar"></div>
        </aside>

        <main class="flex-1 flex overflow-hidden">
            <section id="v-bd" class="flex-1 bg-zinc-200">
                <div class="h-10 border-b border-black/10 flex items-center justify-between px-4 bg-white/50">
                    <span class="text-[9px] font-black opacity-40 uppercase">Memory Storage</span>
                    <button onclick="push()" class="text-[9px] font-black bg-black text-white px-3 py-1 uppercase">Push to Studio</button>
                </div>
                <div id="grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 p-6 overflow-y-auto no-scrollbar pb-32"></div>
            </section>

            <section id="v-in" class="flex-1 pt-20 bg-zinc-100">
                <div class="w-full max-w-xl bg-white border-4 border-black p-8 shadow-[12px_12px_0_0_#000]">
                    <div class="flex gap-2 mb-4">
                        <button id="bi" onclick="setType('Idea')" class="px-4 py-1 border-2 border-black text-[10px] font-black active-btn uppercase">Idea</button>
                        <button id="bq" onclick="setType('æ‘˜éŒ„')" class="px-4 py-1 border-2 border-black text-[10px] font-black uppercase">Quote</button>
                    </div>
                    <textarea id="ed" class="w-full h-64 text-2xl outline-none resize-none font-medium leading-relaxed" placeholder="Record..."></textarea>
                    <div class="mt-4 flex justify-between text-[9px] font-black opacity-30 uppercase">
                        <span>Save & Sync: Cmd+Shift+L</span>
                        <span>View Mode: Cmd+Shift+M</span>
                    </div>
                </div>
            </section>

            <section id="v-st" class="flex-1 bg-white flex flex-col">
                <div class="p-10 border-b-4 border-black shrink-0">
                    <input id="title" class="text-4xl font-900 uppercase w-full outline-none" value="Draft">
                    <div class="mt-4 flex gap-4 text-[10px] font-black opacity-40 uppercase">
                        <button onclick="exp()" class="hover:text-black">Export Markdown</button>
                        <button onclick="if(confirm('Clear?')){proj.s=[];persist();renderSt();}" class="hover:text-black">Clear Project</button>
                    </div>
                </div>
                <div id="canv" class="flex-1 p-12 overflow-y-auto space-y-12 no-scrollbar"></div>
            </section>
        </main>
    </div>

<script>
    const KEY = 'r8nisc7hr8cta77';
    let dbx = null, cards = JSON.parse(localStorage.getItem('Z_C')) || [], proj = JSON.parse(localStorage.getItem('Z_P')) || { s: [] }, type = 'Idea', lid = null;

    window.onkeydown = e => {
        if ((e.metaKey || e.ctrlKey) && e.shiftKey) {
            const k = e.key.toLowerCase();
            if (k === 'l') { e.preventDefault(); save(); }
            if (k === 'm') { e.preventDefault(); go(document.body.className.includes('m-in') ? 'st' : 'in'); }
            if (k === 'b') { e.preventDefault(); go('bd'); }
            if (k === '1' || k === '!') setType('Idea');
            if (k === '2' || k === '@') setType('æ‘˜éŒ„');
        }
    };

    function go(m) {
        document.body.className = 'm-' + m;
        document.getElementById('aux-btn').classList.toggle('hidden', m !== 'st');
        if (m === 'bd' || m === 'st') renderBd();
        if (m === 'st') renderSt();
        if (m === 'in') setTimeout(()=>document.getElementById('ed').focus(), 50);
    }

    function save() {
        const c = document.getElementById('ed').value.trim();
        if (!c) return;
        const id = Math.random().toString(16).slice(2, 6).toUpperCase();
        cards.unshift({ id, c, t: type, time: Date.now(), tags: (c.match(/#([^\s#]+)/g) || []).map(t => t.substring(1)) });
        document.getElementById('ed').value = "";
        persist(); sync(); msg('SAVED #' + id);
        updateTags();
        document.getElementById('ed').focus();
    }

    function startLink(id, e) {
        e.stopPropagation(); lid = id;
        document.body.classList.add('link-mode');
        document.getElementById('link-msg').classList.remove('hidden');
        go('bd');
    }

    function doneLink(id) {
        if(lid && lid !== id) {
            const target = cards.find(x => x.id === id);
            target.c += `\n\nðŸ”— Related: [[${lid}]]`;
            persist(); msg('LINKED!');
        }
        lid = null;
        document.body.classList.remove('link-mode');
        document.getElementById('link-msg').classList.add('hidden');
        renderBd();
    }

    function renderBd() {
        document.getElementById('grid').innerHTML = cards.map(c => `
            <div class="z-card p-5" onclick="${lid ? `doneLink('${c.id}')` : ''}">
                <div class="flex justify-between border-b-2 border-black pb-2 mb-3 text-[10px] font-black uppercase">
                    <span>#${c.id}</span>
                    <div class="flex gap-2">
                        <button onclick="startLink('${c.id}', event)" class="text-blue-600 italic">LINK</button>
                        <input type="checkbox" class="sel w-4 h-4 border-2 border-black" value="${c.id}" onclick="event.stopPropagation()">
                    </div>
                </div>
                <div class="flex-1 overflow-y-auto no-scrollbar text-sm prose prose-sm leading-relaxed">${marked.parse(c.c)}</div>
            </div>`).join('');
    }

    function renderSt() {
        document.getElementById('canv').innerHTML = proj.s.map((s, i) => s.type === 'card' ? 
            `<div class="p-8 bg-white border-l-[16px] border-black shadow-sm relative group">
                <div class="text-blue-600 font-black text-[10px] mb-2 uppercase italic">[[${s.id}]]</div>
                <div class="prose prose-sm">${marked.parse(cards.find(x => x.id === s.id).c)}</div>
                <button onclick="proj.s.splice(${i},1);renderSt();" class="absolute top-4 right-4 hidden group-hover:block text-red-500 font-black text-[9px]">REMOVE</button>
            </div>` : 
            `<textarea oninput="proj.s[${i}].c=this.value;persist();" class="w-full text-xl outline-none border-b-2 border-zinc-100 focus:border-black py-4 font-serif italic" placeholder="Add bridging text...">${s.c}</textarea>`
        ).join('');
    }

    function auth() {
        const a = new Dropbox.DropboxAuth({ clientId: KEY });
        // ä½¿ç”¨ GitHub Pages å°ˆå±¬è·³è½‰è·¯å¾‘
        const uri = "https://andriachiao.github.io/MyZettelSync/";
        window.location.href = a.getAuthenticationUrl(uri);
    }

    async function sync() {
        if (!dbx) return;
        try {
            await dbx.filesUpload({ path: '/vault.json', contents: JSON.stringify(cards), mode: 'overwrite' });
            await dbx.filesUpload({ path: '/project.json', contents: JSON.stringify(proj), mode: 'overwrite' });
        } catch(e) { console.error(e); }
    }

    function push() {
        document.querySelectorAll('.sel:checked').forEach(cb => {
            proj.s.push({ type: 'card', id: cb.value }, { type: 'text', c: '' });
        });
        persist(); go('st');
    }

    function exp() {
        const m = proj.s.map(s => s.type === 'card' ? `\n> ${cards.find(x => x.id === s.id).c}\n` : s.c).join('\n');
        const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([m], {type:'text/markdown'})); a.download = 'Draft.md'; a.click();
    }

    function setType(t) { type = t; document.getElementById('bi').classList.toggle('active-btn', t==='Idea'); document.getElementById('bq').classList.toggle('active-btn', t==='æ‘˜éŒ„'); }
    function persist() { localStorage.setItem('Z_C', JSON.stringify(cards)); localStorage.setItem('Z_P', JSON.stringify(proj)); }
    function msg(m) { const t = document.getElementById('toast'); t.innerText = m; t.classList.add('opacity-100'); setTimeout(() => t.classList.remove('opacity-100'), 2000); }
    function updateTags() {
        const tags = {}; cards.forEach(c => (c.tags||[]).forEach(t => tags[t] = (tags[t]||0)+1));
        document.getElementById('tag-box').innerHTML = Object.entries(tags).map(([k,v]) => `<div class="p-4 border-b border-black/5 text-[11px] font-bold hover:bg-black hover:text-white cursor-pointer flex justify-between uppercase"><span>#${k}</span><span>${v}</span></div>`).join('');
    }

    window.onload = () => {
        const h = new URLSearchParams(window.location.hash.slice(1));
        if (h.get('access_token')) { localStorage.setItem('db_tk', h.get('access_token')); window.history.replaceState({}, "", window.location.pathname); }
        const tk = localStorage.getItem('db_tk');
        if (tk) {
            dbx = new Dropbox.Dropbox({ accessToken: tk });
            document.getElementById('dbx-btn').innerText = "CLOUD ACTIVE";
            document.getElementById('dbx-btn').classList.replace('bg-blue-500', 'bg-green-600');
            sync();
        }
        updateTags(); go('in');
    };
</script>
</body>
</html>
