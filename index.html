<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ZettelStudio | Instant Workflow</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@700&family=Inter:wght@400;900&display=swap');
        body { font-family: 'Inter', sans-serif; background: #f4f4f4; height: 100vh; overflow: hidden; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        /* 動態佈局 */
        .sidebar-transition { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .studio-active #midEditor { display: none; }
        .studio-active #midBoard { display: flex; }
        .studio-active #studioSide { width: 480px; opacity: 1; border-left: 4px solid black; }
        
        #midBoard { display: none; }
        #studioSide { width: 0; opacity: 0; overflow: hidden; }
        
        .idx-item { border-bottom: 2px solid #000; cursor: pointer; padding: 12px 16px; font-size: 11px; font-weight: 700; background: #fff; }
        .idx-item:hover { background: #000; color: #fff; }
        .board-card { border: 3px solid #000; padding: 1rem; background: #fff; box-shadow: 4px 4px 0 #000; position: relative; }
        .card-checkbox { position: absolute; top: 12px; right: 12px; transform: scale(1.4); accent-color: #000; }
        .active-mode-btn { background: black !important; color: white !important; }
    </style>
</head>
<body id="mainBody" class="flex flex-col h-screen">

    <header class="h-14 border-b-4 border-black flex items-center justify-between px-6 bg-white z-[100]">
        <div class="flex items-center gap-6">
            <h1 class="text-lg font-900 uppercase tracking-tighter">ZettelStudio</h1>
            <div class="flex border-2 border-black divide-x-2 divide-black">
                <button onclick="setUIMode('input')" id="btn-input" class="px-4 py-1 text-[10px] font-black uppercase transition">Input (C+1/2)</button>
                <button onclick="setUIMode('studio')" id="btn-studio" class="px-4 py-1 text-[10px] font-black uppercase transition">Studio (C+3)</button>
            </div>
        </div>
        <div class="hidden md:flex gap-4 text-[9px] font-black opacity-30 uppercase">
            <span>C+1:Quote</span> <span>C+2:Idea</span> <span>C+3:Studio</span> <span>C+S:Save</span>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        
        <aside class="w-64 border-r-4 border-black bg-zinc-50 flex flex-col shrink-0">
            <div class="p-4 bg-black text-white text-[10px] font-black uppercase tracking-widest flex justify-between">
                <span>Vault</span><span id="totalNum">0</span>
            </div>
            <div class="flex-1 overflow-y-auto no-scrollbar">
                <div class="idx-item flex justify-between" onclick="setUIMode('studio'); filterBoard('摘錄')"><span>摘錄盒 (Quotes)</span><span id="c-q">0</span></div>
                <div class="idx-item flex justify-between" onclick="setUIMode('studio'); filterBoard('Idea')"><span>Idea 盒 (Thoughts)</span><span id="c-i">0</span></div>
                <div class="p-3 bg-zinc-200 text-[8px] font-black uppercase border-b-2 border-black mt-2">Tag Cloud</div>
                <div id="tagBox"></div>
            </div>
        </aside>

        <main class="flex-1 flex flex-col relative overflow-hidden">
            
            <section id="midEditor" class="flex-1 flex flex-col items-center pt-20 px-10 bg-zinc-100">
                <div class="max-w-xl w-full bg-white border-4 border-black p-8 shadow-[12px_12px_0_0_#000]">
                    <div class="flex justify-between items-center mb-4 border-b-2 border-black pb-3">
                        <span class="mono font-black text-xl text-zinc-300">#CAPTURE</span>
                        <div class="flex gap-2">
                            <div id="badge-quote" class="px-3 py-1 text-[10px] font-black border-2 border-black">QUOTE</div>
                            <div id="badge-idea" class="px-3 py-1 text-[10px] font-black border-2 border-black">IDEA</div>
                        </div>
                    </div>
                    <textarea id="mainIn" class="w-full h-72 text-xl outline-none leading-relaxed bg-transparent resize-none" placeholder="Start thinking..."></textarea>
                    <button onclick="saveCard()" class="mt-6 w-full bg-black text-white py-4 font-900 text-xs uppercase hover:bg-zinc-800">File to Box (Ctrl+S)</button>
                </div>
            </section>

            <section id="midBoard" class="flex-1 flex flex-col p-6 bg-zinc-50">
                <div class="flex justify-between items-center mb-6 border-b-2 border-black pb-2">
                    <h2 class="text-xs font-900 uppercase">Board Index</h2>
                    <button onclick="pushSelected()" class="bg-blue-600 text-white text-[10px] font-black px-6 py-2 uppercase hover:bg-black transition">Push Selected to Project</button>
                </div>
                <div id="boardGrid" class="flex-1 overflow-y-auto grid grid-cols-1 md:grid-cols-2 gap-4 no-scrollbar"></div>
            </section>
        </main>

        <aside id="studioSide" class="bg-white flex flex-col sidebar-transition">
            <div class="p-6 border-b-4 border-black bg-zinc-100 space-y-4">
                <div class="flex justify-between items-center">
                    <input id="projName" class="font-900 text-xl uppercase outline-none bg-transparent border-b-4 border-transparent focus:border-black w-3/4" value="New Project">
                    <select id="projType" class="text-[10px] font-black border-2 border-black p-1 bg-white">
                        <option>論文</option><option>小說</option><option>劇本</option>
                    </select>
                </div>
                <div class="flex justify-between">
                    <button onclick="exportDoc()" class="text-[10px] font-black bg-black text-white px-4 py-1">EXPORT .MD</button>
                    <button onclick="clearProj()" class="text-[10px] font-black text-red-500 underline uppercase">Clear</button>
                </div>
            </div>
            <div id="studioCanvas" class="flex-1 overflow-y-auto p-8 no-scrollbar space-y-8"></div>
        </aside>

    </div>

<script>
    let cards = JSON.parse(localStorage.getItem('Z_Cards_Final')) || [];
    let project = JSON.parse(localStorage.getItem('Z_Proj_Final')) || { segments: [] };
    let currentInputMode = 'Idea';

    // 強大的全局快捷鍵監聽
    window.addEventListener('keydown', e => {
        const ctrl = e.ctrlKey || e.metaKey;
        if (ctrl && e.key === '1') { e.preventDefault(); setInputMode('摘錄'); setUIMode('input'); }
        if (ctrl && e.key === '2') { e.preventDefault(); setInputMode('Idea'); setUIMode('input'); }
        if (ctrl && e.key === '3') { e.preventDefault(); setUIMode('studio'); }
        if (ctrl && e.key === 's') { e.preventDefault(); saveCard(); }
        if (ctrl && e.key === 'b') { e.preventDefault(); if(document.body.classList.contains('studio-active')) renderBoard(); }
    });

    window.onload = () => {
        updateStats();
        setInputMode('Idea');
        setUIMode('input');
    };

    function setUIMode(mode) {
        const body = document.getElementById('mainBody');
        const btnI = document.getElementById('btn-input');
        const btnS = document.getElementById('btn-studio');

        if(mode === 'studio') {
            body.classList.add('studio-active');
            btnS.classList.add('active-mode-btn');
            btnI.classList.remove('active-mode-btn');
            renderBoard();
            renderProject();
        } else {
            body.classList.remove('studio-active');
            btnI.classList.add('active-mode-btn');
            btnS.classList.remove('active-mode-btn');
            document.getElementById('mainIn').focus();
        }
    }

    function setInputMode(m) {
        currentInputMode = m;
        document.getElementById('badge-quote').className = m === '摘錄' ? 'px-3 py-1 text-[10px] font-black bg-black text-white border-2 border-black' : 'px-3 py-1 text-[10px] font-black border-2 border-black';
        document.getElementById('badge-idea').className = m === 'Idea' ? 'px-3 py-1 text-[10px] font-black bg-black text-white border-2 border-black' : 'px-3 py-1 text-[10px] font-black border-2 border-black';
    }

    function saveCard() {
        const content = document.getElementById('mainIn').value.trim();
        if(!content) return;
        const id = (Math.floor(Date.now() / 1000) % 0xFFFF).toString(16).toUpperCase().padStart(4, '0');
        cards.unshift({ id, content, mode: currentInputMode, time: Date.now(), tags: (content.match(/#[^\s]+/g) || []).map(t => t.substring(1)) });
        localStorage.setItem('Z_Cards_Final', JSON.stringify(cards));
        document.getElementById('mainIn').value = "";
        updateStats();
        alert('Saved to Box!');
    }

    function updateStats() {
        document.getElementById('totalNum').innerText = cards.length;
        document.getElementById('c-q').innerText = cards.filter(c => c.mode === '摘錄').length;
        document.getElementById('c-i').innerText = cards.filter(c => c.mode === 'Idea').length;
        const tags = {}; cards.forEach(c => c.tags.forEach(t => tags[t] = (tags[t]||0)+1));
        document.getElementById('tagBox').innerHTML = Object.entries(tags).map(([k,v]) => `
            <div class="idx-item flex justify-between" onclick="setUIMode('studio'); filterBoard('${k}')"><span>#${k}</span><span class="opacity-30">${v}</span></div>
        `).join('');
    }

    function renderBoard(filter) {
        let list = filter ? cards.filter(c => c.tags.includes(filter) || c.mode === filter) : cards;
        document.getElementById('boardGrid').innerHTML = list.map(c => `
            <div class="board-card">
                <input type="checkbox" class="card-checkbox" value="${c.id}">
                <div class="text-[9px] font-black opacity-30 mb-2 uppercase">${c.mode} #${c.id}</div>
                <div class="text-xs font-bold leading-relaxed">${marked.parse(c.content)}</div>
            </div>
        `).join('');
    }

    function filterBoard(val) { renderBoard(val); }

    function pushSelected() {
        const checked = document.querySelectorAll('.card-checkbox:checked');
        checked.forEach(cb => {
            project.segments.push({ type: 'card', id: cb.value });
            project.segments.push({ type: 'text', content: '' });
        });
        saveProject();
        renderProject();
        checked.forEach(cb => cb.checked = false);
    }

    function renderProject() {
        const canvas = document.getElementById('studioCanvas');
        canvas.innerHTML = project.segments.map((seg, idx) => {
            if(seg.type === 'card') {
                const c = cards.find(x => x.id === seg.id);
                return `<div class="p-4 bg-zinc-50 border-l-8 border-black text-xs italic relative group">
                    <span class="font-900">[[${c.id}]]</span> ${c.content.substring(0,100)}...
                    <button onclick="removeSeg(${idx})" class="absolute -right-2 -top-2 bg-red-500 text-white rounded-full w-5 h-5 hidden group-hover:flex items-center justify-center text-xs">×</button>
                </div>`;
            } else {
                return `<textarea oninput="project.segments[${idx}].content=this.value;saveProject()" class="w-full min-h-[100px] text-sm outline-none bg-transparent border-b-2 border-zinc-100 focus:border-black py-2" placeholder="Write development...">${seg.content}</textarea>`;
            }
        }).join('');
    }

    function removeSeg(idx) { project.segments.splice(idx, 1); saveProject(); renderProject(); }
    function saveProject() { localStorage.setItem('Z_Proj_Final', JSON.stringify(project)); }
    function clearProj() { if(confirm('Clear Project?')) { project.segments = []; renderProject(); saveProject(); } }

    function exportDoc() {
        const name = document.getElementById('projName').value;
        const type = document.getElementById('projType').value;
        let md = `# ${type}: ${name}\n\n`;
        project.segments.forEach(s => {
            if(s.type === 'card') md += `\n> ${cards.find(x => x.id === s.id).content}\n\n`;
            else md += s.content + "\n";
        });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([md]));
        a.download = `${type}_${name}.md`;
        a.click();
    }
</script>
</body>
</html>
