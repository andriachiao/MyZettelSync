<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ZET-SYNC ULTIMATE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dropbox.js/10.34.0/Dropbox-sdk.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background: #f8fafc; color: #1e293b; }
        .wiki-link { color: #6366f1; font-weight: bold; cursor: pointer; text-decoration: underline; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .card-active { border-color: #6366f1; box-shadow: 0 0 0 2px #6366f133; }
    </style>
</head>
<body class="flex flex-col md:flex-row h-screen overflow-hidden">

    <aside class="w-full md:w-80 bg-white border-r border-slate-200 flex flex-col shadow-sm z-30">
        <div class="p-6">
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-xl font-900 tracking-tighter">ZET-SYNC <span class="text-[10px] bg-indigo-600 text-white px-1 rounded">PRO</span></h1>
                <span id="cloudIndicator" class="text-[9px] font-bold opacity-50">OFFLINE</span>
            </div>
            
            <div id="revisitPanel" class="hidden mb-6 p-3 bg-amber-50 rounded-xl border border-amber-100">
                <p class="text-[10px] font-black text-amber-600 uppercase mb-2">⏳ 需復閱 (Ctrl+R)</p>
                <div id="revisitList" class="space-y-1"></div>
            </div>

            <div class="mb-4 flex justify-between items-center text-[10px] font-black text-slate-400 uppercase tracking-widest">
                <span>Tags & Boards</span>
            </div>
            <div id="tagList" class="flex-1 overflow-y-auto space-y-1 no-scrollbar max-h-[50vh]"></div>
        </div>
        
        <div class="mt-auto p-6 border-t border-slate-50 bg-slate-50/50">
            <button onclick="authDropbox()" class="w-full py-2 text-[11px] font-bold bg-white border rounded-xl hover:bg-slate-100 transition">CONNECT DROPBOX</button>
        </div>
    </aside>

    <main class="flex-1 overflow-y-auto no-scrollbar relative bg-slate-50">
        <div class="max-w-4xl mx-auto p-6 md:p-12">
            
            <div class="flex gap-4 mb-8">
                <div class="relative flex-1">
                    <i class="fa-solid fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-300 text-sm"></i>
                    <input type="text" id="searchInput" oninput="renderCards()" placeholder="搜尋... (Ctrl+F)" 
                        class="w-full pl-11 pr-4 py-3 bg-white rounded-2xl border-none shadow-sm focus:ring-2 focus:ring-indigo-400 outline-none transition-all">
                </div>
                <button id="viewToggle" onclick="toggleView()" class="px-4 py-3 bg-white rounded-2xl shadow-sm text-slate-400 hover:text-indigo-600 transition">
                    <i class="fa-solid fa-table-columns"></i>
                </button>
            </div>

            <div id="dropZone" class="bg-white rounded-[32px] shadow-sm border border-slate-100 overflow-hidden mb-10 transition-all focus-within:shadow-xl focus-within:shadow-indigo-100/50">
                <div class="px-6 py-3 bg-slate-50/50 border-b border-slate-50 flex justify-between items-center">
                    <div id="entryBadge" class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Standard Mode</div>
                    <div class="text-[9px] font-bold text-slate-300">CMD+ENTER TO SAVE</div>
                </div>
                <textarea id="cardInput" class="w-full p-8 text-lg border-none focus:ring-0 outline-none text-slate-700 placeholder-slate-200 min-h-[160px]" 
                    placeholder="輸入內容... 使用 -標籤 和 #關鍵詞"></textarea>
                <div id="imagePreview" class="px-8 pb-4 flex flex-wrap gap-2"></div>
            </div>

            <div id="cardList" class="space-y-6 pb-40"></div>
        </div>
    </main>

    <div id="modal" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-[40px] max-w-5xl w-full flex flex-col md:flex-row shadow-2xl overflow-hidden max-h-[85vh]">
            <div class="flex-1 p-8 md:p-12 overflow-y-auto custom-scrollbar">
                <div id="modalHeader" class="mb-6"></div>
                <div id="modalContent" class="prose prose-slate max-w-none text-slate-700 leading-relaxed"></div>
                <div id="modalImages" class="mt-8 space-y-4"></div>
            </div>
            <div class="w-full md:w-72 bg-slate-50 p-8 border-l border-slate-100">
                <h4 class="text-[10px] font-black text-slate-400 uppercase mb-4 tracking-widest">Backlinks</h4>
                <div id="backlinksList" class="space-y-2 mb-8"></div>
                <button onclick="closeModal()" class="w-full py-4 bg-slate-900 text-white rounded-2xl font-black text-sm active:scale-95 transition">CLOSE (Esc)</button>
            </div>
        </div>
    </div>

<script>
    let cards = JSON.parse(localStorage.getItem('zet_cards')) || [];
    let db, dbx, pendingImages = [], currentView = 'stream', currentBoardKey = null;
    const DBX_APP_KEY = '你的APP_KEY'; // <--- 記得換成你的！

    // 初始化
    const dbReq = indexedDB.open("ZetImages", 1);
    dbReq.onupgradeneeded = e => e.target.result.createObjectStore("images", { keyPath: "id" });
    dbReq.onsuccess = e => { db = e.target.result; updateUI(); };

    window.onload = () => {
        initDropbox();
        initShortcuts();
        initDragAndDrop();
    };

    // --- 快捷鍵系統 (適配 Mac) ---
    function initShortcuts() {
        document.addEventListener('keydown', e => {
            const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
            const cmd = isMac ? e.metaKey : e.ctrlKey;

            if (e.ctrlKey && e.key === '1') { e.preventDefault(); setEntryType('摘錄', 'text-indigo-600'); }
            if (e.ctrlKey && e.key === '2') { e.preventDefault(); setEntryType('Idea', 'text-emerald-600'); }
            if (e.ctrlKey && e.key === 'b') { e.preventDefault(); toggleView(); }
            if (e.ctrlKey && e.key === 'r') { e.preventDefault(); focusRevisit(); }
            if (e.ctrlKey && e.key === 'f') { e.preventDefault(); document.getElementById('searchInput').focus(); }
            if (cmd && e.key === 'Enter') { e.preventDefault(); saveCard(); }
            if (e.key === 'Escape') closeModal();
        });
    }

    function setEntryType(type, color) {
        const input = document.getElementById('cardInput');
        document.getElementById('entryBadge').innerText = type + " Mode";
        document.getElementById('entryBadge').className = `text-[9px] font-black uppercase tracking-widest ${color}`;
        if (!input.value.includes(`-${type}`)) input.value += ` -${type} `;
        input.focus();
    }

    // --- 核心儲存邏輯 ---
    async function saveCard() {
        const input = document.getElementById('cardInput');
        const text = input.value.trim();
        if (!text && pendingImages.length === 0) return;

        const tags = (text.match(/-[^\s]+/g) || []).map(t => t.substring(1));
        const kws = (text.match(#[^\s]+/g) || []).map(k => k.substring(1));
        const cardId = Math.random().toString(36).substr(2, 4).toUpperCase();

        const newCard = {
            id: cardId, fullId: Date.now(), content: text,
            tags: tags.length ? tags : ["未分類"],
            keywords: kws, time: Date.now(), status: 'draft',
            images: pendingImages.map(i => i.id),
            order: 0 // 用於看板排序
        };

        if (pendingImages.length > 0) {
            const tx = db.transaction("images", "readwrite");
            pendingImages.forEach(img => tx.objectStore("images").put(img));
        }

        cards.unshift(newCard);
        input.value = "";
        pendingImages = [];
        document.getElementById('imagePreview').innerHTML = "";
        saveAndRefresh();
        if (dbx) uploadToCloud();
    }

    // --- 看板邏輯 ---
    function toggleView() {
        currentView = currentView === 'stream' ? 'board' : 'stream';
        renderCards();
    }

    function moveOrder(fid, dir) {
        const boardCards = cards.filter(c => c.tags.includes(currentBoardKey) || (c.keywords && c.keywords.includes(currentBoardKey)));
        const idx = boardCards.findIndex(c => c.fullId == fid);
        if (idx + dir < 0 || idx + dir >= boardCards.length) return;
        
        // 交換順序邏輯 (簡單實作：交換在 cards 陣列中的位置)
        const globalIdx = cards.findIndex(c => c.fullId == fid);
        const targetFid = boardCards[idx + dir].fullId;
        const targetGlobalIdx = cards.findIndex(c => c.fullId == targetFid);
        
        [cards[globalIdx], cards[targetGlobalIdx]] = [cards[targetGlobalIdx], cards[globalIdx]];
        saveAndRefresh();
    }

    // --- 渲染系統 ---
    async function renderCards() {
        const list = document.getElementById('cardList');
        const term = document.getElementById('searchInput').value.toLowerCase();
        
        let filtered = cards.filter(c => 
            (term === "" || c.content.toLowerCase().includes(term) || (c.keywords && c.keywords.some(k => k.toLowerCase().includes(term))))
        );

        if (currentView === 'board' && currentBoardKey) {
            filtered = filtered.filter(c => c.tags.includes(currentBoardKey) || (c.keywords && c.keywords.includes(currentBoardKey)));
        }

        let html = "";
        for (let c of filtered) {
            const content = marked.parse(c.content.replace(/-[^\s]+|#[^\s]+/g, ''));
            const isBoard = currentView === 'board';
            
            html += `
                <div class="bg-white p-6 md:p-8 rounded-[32px] border border-slate-100 shadow-sm flex gap-4">
                    ${isBoard ? `
                    <div class="flex flex-col justify-center gap-4 text-slate-300">
                        <button onclick="moveOrder(${c.fullId}, -1)" class="hover:text-indigo-500"><i class="fa-solid fa-chevron-up"></i></button>
                        <button onclick="moveOrder(${c.fullId}, 1)" class="hover:text-indigo-500"><i class="fa-solid fa-chevron-down"></i></button>
                    </div>` : ''}
                    <div class="flex-1 cursor-pointer" onclick="showCardDetail('${c.fullId}')">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex flex-wrap gap-2">
                                ${c.keywords ? c.keywords.map(k => `<span class="bg-amber-50 text-amber-600 text-[9px] font-black px-2 py-0.5 rounded-lg border border-amber-100">#${k}</span>`).join('') : ''}
                            </div>
                            <span class="text-[9px] font-mono text-slate-300">${c.id}</span>
                        </div>
                        <div class="prose prose-slate prose-sm line-clamp-3">${content}</div>
                        <div class="mt-4 flex gap-2">
                            ${c.tags.map(t => `<span class="text-indigo-400 text-[9px] font-bold uppercase tracking-widest">@${t}</span>`).join('')}
                        </div>
                    </div>
                </div>
            `;
        }
        list.innerHTML = html || `<div class="text-center py-20 text-slate-300 font-bold italic">No cards found.</div>`;
    }

    function renderTags() {
        const tagCounts = {};
        cards.forEach(c => c.tags.forEach(t => tagCounts[t] = (tagCounts[t] || 0) + 1));
        
        document.getElementById('tagList').innerHTML = Object.entries(tagCounts).map(([t, c]) => `
            <div class="group flex justify-between items-center p-2 px-3 rounded-xl hover:bg-slate-50 transition cursor-pointer ${currentBoardKey === t ? 'bg-indigo-50' : ''}">
                <span onclick="currentBoardKey='${t}'; currentView='board'; renderCards();" class="text-xs font-bold text-slate-600">@ ${t} <span class="opacity-30 text-[10px] ml-1">${c}</span></span>
                <i onclick="deleteTag('${t}')" class="fa-solid fa-times text-[10px] text-slate-200 group-hover:text-red-400 p-1"></i>
            </div>
        `).join('');

        // 更新復閱
        const weekAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);
        const revisit = cards.filter(c => c.time < weekAgo && c.status === 'draft').slice(0, 3);
        if (revisit.length > 0) {
            document.getElementById('revisitPanel').classList.remove('hidden');
            document.getElementById('revisitList').innerHTML = revisit.map(c => `
                <div onclick="showCardDetail('${c.fullId}')" class="text-[11px] text-amber-700 cursor-pointer hover:underline">→ ${c.id}</div>
            `).join('');
        }
    }

    async function showCardDetail(fid) {
        const card = cards.find(c => c.fullId == fid);
        const modal = document.getElementById('modal');
        document.getElementById('modalHeader').innerHTML = `<h2 class="text-xs font-black text-indigo-500 uppercase tracking-widest">Card ${card.id} / ${new Date(card.time).toLocaleDateString()}</h2>`;
        document.getElementById('modalContent').innerHTML = marked.parse(card.content).replace(/\[\[([A-Z0-9]+)\]\]/g, '<span class="wiki-link" onclick="jumpTo(\'$1\')">[[$1]]</span>');
        
        // 反向連結
        const backlinks = cards.filter(c => c.content.includes(`[[${card.id}]]`));
        document.getElementById('backlinksList').innerHTML = backlinks.map(c => `
            <div onclick="showCardDetail('${c.fullId}')" class="p-3 bg-white rounded-2xl border border-slate-100 text-[10px] font-bold cursor-pointer hover:border-indigo-400">[[${c.id}]]</div>
        `).join('') || '<p class="text-[9px] text-slate-300 italic">No links yet.</p>';

        modal.classList.remove('hidden');
    }

    function deleteTag(tagName) {
        if (confirm(`Delete @${tagName} from all cards?`)) {
            cards.forEach(c => {
                c.tags = c.tags.filter(t => t !== tagName);
                c.content = c.content.replace(new RegExp(`-${tagName}`, 'g'), '');
            });
            saveAndRefresh();
        }
    }

    // --- 基礎工具 ---
    function saveAndRefresh() {
        localStorage.setItem('zet_cards', JSON.stringify(cards));
        renderTags();
        renderCards();
    }
    function updateUI() { renderTags(); renderCards(); }
    function closeModal() { document.getElementById('modal').classList.add('hidden'); }
    function jumpTo(id) { const c = cards.find(x => x.id === id); if(c) showCardDetail(c.fullId); }
    function focusRevisit() { const first = document.querySelector('#revisitList div'); if(first) first.click(); }
    function authDropbox() { window.location.href = `https://www.dropbox.com/oauth2/authorize?client_id=${DBX_APP_KEY}&response_type=token&redirect_uri=${encodeURIComponent(window.location.href.split('#')[0])}`; }
    function initDropbox() {
        const token = new URLSearchParams(window.location.hash.substring(1)).get('access_token');
        if (token) {
            dbx = new Dropbox.Dropbox({ accessToken: token });
            document.getElementById('cloudIndicator').innerText = "ONLINE";
            document.getElementById('cloudIndicator').className = "text-[9px] font-black text-green-500";
        }
    }
    function initDragAndDrop() { /* 保持原有的圖片拖拽邏輯 */ }
</script>
</body>
</html>
