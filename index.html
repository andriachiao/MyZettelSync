<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ZET-SYNC | INDEX CARD PRO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dropbox.js/10.34.0/Dropbox-sdk.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=JetBrains+Mono&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #e2e8f0; color: #1e293b; }
        
        /* å¯¦é«”ç´¢å¼•å¡é¢¨æ ¼ */
        .index-card {
            background: #ffffff;
            border-top: 24px solid #f1f5f9; /* ç´¢å¼•å¡ä¸Šæ²¿ */
            position: relative;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s;
        }
        .index-card::before {
            content: ""; position: absolute; top: -18px; left: 20px;
            width: 40px; height: 12px; background: rgba(0,0,0,0.05); border-radius: 2px;
        }
        
        .wiki-link { color: #6366f1; font-weight: bold; cursor: pointer; text-decoration: underline; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* èƒŒæ™¯å¿«æ·éµèªªæ˜ */
        .shortcut-guide {
            position: fixed; bottom: 20px; right: 20px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px; color: #94a3b8; line-height: 1.6;
            pointer-events: none; z-index: 0;
            background: rgba(255,255,255,0.5); padding: 15px; border-radius: 15px;
        }
    </style>
</head>
<body class="flex flex-col md:flex-row h-screen overflow-hidden">

    <div class="shortcut-guide hidden md:block">
        <p class="font-black text-slate-500 mb-1 uppercase text-[9px]">Keyboard Shortcuts (Mac)</p>
        <div>â‡§ + âŒ¥ + 1 : ğŸ“š æ‘˜éŒ„æ¨¡å¼</div>
        <div>â‡§ + âŒ¥ + 2 : ğŸ’¡ éˆæ„Ÿæ¨¡å¼</div>
        <div>â‡§ + âŒ¥ + B : ğŸ“‹ åˆ‡æ›çœ‹æ¿</div>
        <div>â‡§ + âŒ¥ + R : â³ å¿«é€Ÿè¤‡é–±</div>
        <div>â‡§ + âŒ¥ + F : ğŸ” æœå°‹ç„¦é»</div>
        <div>âŒ˜ + ENTER : ğŸ’¾ å„²å­˜å¡ç‰‡</div>
        <div>ESC : âŒ é—œé–‰å½ˆçª—</div>
    </div>

    <aside class="w-full md:w-72 bg-slate-900 text-white flex flex-col z-30 shadow-2xl">
        <div class="p-6">
            <h1 class="text-xl font-900 tracking-tighter mb-1">ZET-SYNC</h1>
            <div id="cloudIndicator" class="text-[9px] font-black opacity-40 uppercase tracking-widest mb-8 text-white">Cloud Disconnected</div>
            
            <div id="revisitPanel" class="hidden mb-8 p-3 bg-white/10 rounded-xl border border-white/10">
                <p class="text-[9px] font-black text-amber-400 uppercase mb-2">â³ éœ€è¤‡é–± (â‡§âŒ¥R)</p>
                <div id="revisitList" class="space-y-1"></div>
            </div>

            <div class="text-[9px] font-black text-slate-500 uppercase tracking-widest mb-4">Categories</div>
            <div id="tagList" class="space-y-1 overflow-y-auto no-scrollbar max-h-[60vh]"></div>
        </div>
        <div class="mt-auto p-6 bg-black/20">
            <button onclick="authDropbox()" class="w-full py-3 text-[10px] font-black bg-indigo-600 rounded-xl hover:bg-indigo-500 transition uppercase tracking-widest">Connect Dropbox</button>
        </div>
    </aside>

    <main class="flex-1 overflow-y-auto no-scrollbar relative p-4 md:p-12">
        <div class="max-w-3xl mx-auto">
            
            <div class="mb-10">
                <input type="text" id="searchInput" oninput="renderCards()" placeholder="Search your thoughts... (â‡§âŒ¥F)" 
                    class="w-full px-6 py-4 bg-white/60 backdrop-blur rounded-2xl border-none shadow-inner focus:ring-2 focus:ring-indigo-400 outline-none transition-all">
            </div>

            <div class="index-card rounded-2xl mb-12 overflow-hidden shadow-2xl border-t-[30px] border-indigo-600">
                <div class="absolute top-[-22px] left-6 text-[10px] font-black text-white uppercase tracking-widest" id="entryTypeDisplay">Standard Entry</div>
                <textarea id="cardInput" class="w-full p-8 text-lg border-none focus:ring-0 outline-none text-slate-700 placeholder-slate-300 min-h-[180px] leading-relaxed" 
                    placeholder="Write something... use -tags and #keywords"></textarea>
                <div class="px-8 py-3 bg-slate-50 border-t flex justify-between items-center text-[10px] font-bold text-slate-400 uppercase">
                    <span>Press âŒ˜+Enter to file this card</span>
                    <span id="charCount">0 chars</span>
                </div>
            </div>

            <div id="cardList" class="space-y-8 pb-40"></div>
        </div>
    </main>

    <div id="modal" class="hidden fixed inset-0 bg-slate-900/80 backdrop-blur-md flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-[32px] max-w-4xl w-full flex flex-col md:flex-row shadow-2xl overflow-hidden max-h-[85vh]">
            <div class="flex-1 p-8 md:p-12 overflow-y-auto">
                <div id="modalHeader" class="mb-6"></div>
                <div id="modalContent" class="prose prose-slate max-w-none text-lg"></div>
            </div>
            <div class="w-full md:w-64 bg-slate-50 p-8 border-l border-slate-100 flex flex-col">
                <h4 class="text-[10px] font-black text-slate-400 uppercase mb-4 tracking-widest">Backlinks</h4>
                <div id="backlinksList" class="flex-1 space-y-2 mb-8"></div>
                <button onclick="closeModal()" class="w-full py-4 bg-slate-900 text-white rounded-2xl font-black text-xs uppercase transition active:scale-95">Close (Esc)</button>
            </div>
        </div>
    </div>

<script>
    let cards = JSON.parse(localStorage.getItem('zet_cards')) || [];
    let dbx, currentView = 'stream', currentBoardKey = null;
    const DBX_APP_KEY = 'r8nisc7hr8cta77'; // <--- æ›¿æ›ä½ çš„ Key

    window.onload = () => {
        initDropbox();
        initShortcuts();
        renderTags();
        renderCards();
        document.getElementById('cardInput').addEventListener('input', e => {
            document.getElementById('charCount').innerText = `${e.target.value.length} chars`;
        });
    };

    // --- å¿«æ·éµç³»çµ± (â‡§ + âŒ¥ å„ªåŒ–ç‰ˆ) ---
    function initShortcuts() {
        document.addEventListener('keydown', e => {
            const isAction = e.shiftKey && e.altKey;
            const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
            const cmd = isMac ? e.metaKey : e.ctrlKey;

            if (isAction && e.key === '1') { e.preventDefault(); setMode('æ‘˜éŒ„', 'border-indigo-600'); }
            if (isAction && e.key === '2') { e.preventDefault(); setMode('Idea', 'border-emerald-500'); }
            if (isAction && e.key === 'b') { e.preventDefault(); toggleView(); }
            if (isAction && e.key === 'r') { e.preventDefault(); focusRevisit(); }
            if (isAction && e.key === 'f') { e.preventDefault(); document.getElementById('searchInput').focus(); }
            if (cmd && e.key === 'Enter') { e.preventDefault(); saveCard(); }
            if (e.key === 'Escape') closeModal();
        });
    }

    function setMode(type, borderColor) {
        document.querySelector('.index-card').style.borderTopColor = getComputedStyle(document.documentElement).getPropertyValue('--tw-border-opacity') ? borderColor : borderColor; 
        // ç°¡å–®åˆ‡æ›é‚Šæ¡†é¡è‰²
        const el = document.querySelector('.index-card');
        el.className = el.className.replace(/border-t-\[.*?\]/, '');
        document.getElementById('entryTypeDisplay').innerText = `${type} Mode`;
        const input = document.getElementById('cardInput');
        if (!input.value.includes(`-${type}`)) input.value = `-${type} ` + input.value;
        input.focus();
    }

    // --- å„²å­˜èˆ‡æ¸²æŸ“ ---
    function saveCard() {
        const input = document.getElementById('cardInput');
        const text = input.value.trim();
        if (!text) return;

        const tags = (text.match(/-[^\s]+/g) || []).map(t => t.substring(1));
        const kws = (text.match(/#[^\s]+/g) || []).map(k => k.substring(1));
        const cardId = Math.random().toString(36).substr(2, 4).toUpperCase();

        const newCard = {
            id: cardId, fullId: Date.now(), content: text,
            tags: tags.length ? tags : ["æœªåˆ†é¡"],
            keywords: kws, time: Date.now(), status: 'draft'
        };

        cards.unshift(newCard);
        input.value = "";
        saveAndRefresh();
        if (dbx) uploadToCloud();
    }

    function renderCards() {
        const list = document.getElementById('cardList');
        const term = document.getElementById('searchInput').value.toLowerCase();
        
        let filtered = cards.filter(c => (term === "" || c.content.toLowerCase().includes(term)));
        if (currentView === 'board' && currentBoardKey) {
            filtered = filtered.filter(c => c.tags.includes(currentBoardKey) || c.keywords.includes(currentBoardKey));
        }

        list.innerHTML = filtered.map((c, i) => `
            <div class="index-card rounded-2xl p-8 cursor-pointer hover:scale-[1.01] transition-all" onclick="showCardDetail('${c.fullId}')">
                <div class="flex justify-between items-start mb-6">
                    <div class="flex gap-2">
                        ${c.keywords ? c.keywords.map(k => `<span class="bg-amber-100 text-amber-700 text-[9px] font-black px-2 py-0.5 rounded">#${k}</span>`).join('') : ''}
                    </div>
                    <span class="font-mono text-[10px] text-slate-300">ID: ${c.id}</span>
                </div>
                <div class="prose prose-slate prose-sm line-clamp-4 mb-6">${marked.parse(c.content.replace(/-[^\s]+|#[^\s]+/g, ''))}</div>
                <div class="flex justify-between items-end border-t border-slate-50 pt-4">
                    <div class="flex gap-2">
                        ${c.tags.map(t => `<span class="text-[9px] font-black text-indigo-400 uppercase tracking-tighter">@${t}</span>`).join('')}
                    </div>
                    <div class="text-[10px] font-bold text-slate-300 italic">${new Date(c.time).toLocaleDateString()}</div>
                </div>
                ${currentView === 'board' ? `
                    <div class="absolute left-[-40px] top-1/2 -translate-y-1/2 flex flex-col gap-2 opacity-0 hover:opacity-100 transition">
                        <button onclick="event.stopPropagation(); moveCard(${i}, -1)" class="bg-white p-2 rounded-full shadow text-xs"><i class="fa-solid fa-arrow-up"></i></button>
                        <button onclick="event.stopPropagation(); moveCard(${i}, 1)" class="bg-white p-2 rounded-full shadow text-xs"><i class="fa-solid fa-arrow-down"></i></button>
                    </div>
                ` : ''}
            </div>
        `).join('');
    }

    function renderTags() {
        const tagCounts = {};
        cards.forEach(c => c.tags.forEach(t => tagCounts[t] = (tagCounts[t] || 0) + 1));
        document.getElementById('tagList').innerHTML = Object.entries(tagCounts).map(([t, c]) => `
            <div class="group flex justify-between items-center px-4 py-2 rounded-xl cursor-pointer hover:bg-white/10 ${currentBoardKey === t ? 'bg-indigo-600' : ''}">
                <span onclick="currentBoardKey='${t}'; currentView='board'; renderCards();" class="text-xs font-bold text-slate-300">@ ${t} <span class="opacity-30 ml-1 text-[10px]">${c}</span></span>
                <i onclick="deleteTag('${t}')" class="fa-solid fa-trash text-[10px] text-slate-600 group-hover:text-red-400 ml-2"></i>
            </div>
        `).join('');

        // è¤‡é–±æ¸…å–®
        const weekAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);
        const revisit = cards.filter(c => c.time < weekAgo && c.status === 'draft').slice(0, 3);
        if (revisit.length > 0) {
            document.getElementById('revisitPanel').classList.remove('hidden');
            document.getElementById('revisitList').innerHTML = revisit.map(c => `<div onclick="showCardDetail('${c.fullId}')" class="text-[10px] text-amber-200 hover:underline cursor-pointer tracking-tight">â†’ Card ${c.id}</div>`).join('');
        }
    }

    async function showCardDetail(fid) {
        const card = cards.find(c => c.fullId == fid);
        document.getElementById('modalHeader').innerHTML = `<h2 class="text-xs font-black text-indigo-500 uppercase tracking-widest">Index Card ${card.id}</h2>`;
        document.getElementById('modalContent').innerHTML = marked.parse(card.content).replace(/\[\[([A-Z0-9]+)\]\]/g, '<span class="wiki-link" onclick="jumpTo(\'$1\')">[[$1]]</span>');
        
        const links = cards.filter(c => c.content.includes(`[[${card.id}]]`));
        document.getElementById('backlinksList').innerHTML = links.map(c => `
            <div onclick="showCardDetail('${c.fullId}')" class="p-3 bg-white rounded-xl border border-slate-100 text-[10px] font-bold cursor-pointer hover:border-indigo-400 truncate">[[${c.id}]] ${c.content.substring(0,10)}...</div>
        `).join('') || '<p class="text-[10px] text-slate-300 italic">No links</p>';
        document.getElementById('modal').classList.remove('hidden');
    }

    function toggleView() { currentView = currentView === 'stream' ? 'board' : 'stream'; renderCards(); }
    function closeModal() { document.getElementById('modal').classList.add('hidden'); }
    function jumpTo(id) { const c = cards.find(x => x.id === id); if(c) showCardDetail(c.fullId); }
    function focusRevisit() { const first = document.querySelector('#revisitList div'); if(first) first.click(); }
    function saveAndRefresh() { localStorage.setItem('zet_cards', JSON.stringify(cards)); renderTags(); renderCards(); }
    function authDropbox() { window.location.href = `https://www.dropbox.com/oauth2/authorize?client_id=${DBX_APP_KEY}&response_type=token&redirect_uri=${encodeURIComponent(window.location.href.split('#')[0])}`; }
    function initDropbox() {
        const token = new URLSearchParams(window.location.hash.substring(1)).get('access_token');
        if (token) {
            dbx = new Dropbox.Dropbox({ accessToken: token });
            document.getElementById('cloudIndicator').innerText = "Cloud Online";
            document.getElementById('cloudIndicator').classList.add('text-green-400');
        }
    }
    function deleteTag(t) { if(confirm(`Delete tag @${t}?`)) { cards.forEach(c => c.tags = c.tags.filter(tg => tg !== t)); saveAndRefresh(); } }
</script>
</body>
</html>
