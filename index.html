<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>MyZettelSync | 聯想索引版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@700&family=Inter:wght@400;900&display=swap');
        body { font-family: 'Inter', sans-serif; background: #fff; color: #000; height: 100vh; overflow: hidden; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .border-k { border: 3px solid #000; }
        
        /* 雙向連結實體標籤 */
        .link-node { background: #000; color: #fff; padding: 2px 8px; font-size: 10px; cursor: pointer; border: 1px solid #fff; }
        .backlink-node { background: #eee; color: #000; border: 1px solid #000; }

        /* 極簡索引 */
        .kw-item { border-bottom: 2px solid #000; cursor: pointer; transition: 0.2s; }
        .kw-item:hover { background: #000; color: #fff; }

        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="flex flex-col">

    <header class="h-16 border-b-4 border-black flex items-center justify-between px-8 bg-white z-50">
        <div class="flex items-center gap-8">
            <h1 class="text-xl font-900 tracking-tighter uppercase">MyZettelSync</h1>
            <div id="syncStatus" class="flex items-center gap-2 text-[10px] font-black">
                <span onclick="exportMarkdown()" class="cursor-pointer border-2 border-black px-2">EXPORT MD</span>
                <span onclick="backupToDropbox()" class="cursor-pointer border-2 border-black px-2">SYNC DBX</span>
            </div>
        </div>
        <div id="revisitIndicator" class="text-[10px] font-black underline cursor-pointer">TIMER SETTING</div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <aside class="w-64 border-r-4 border-black flex flex-col shrink-0 bg-white">
            <div class="p-6 border-b-4 border-black">
                <p class="text-[10px] font-900 uppercase mb-4">Keywords Index</p>
                <input type="text" id="kwSearch" oninput="renderKeywords()" placeholder="FILTER TAGS..." class="w-full text-xs font-bold outline-none border-b-2 border-black pb-1">
            </div>
            <div id="keywordBox" class="flex-1 overflow-y-auto no-scrollbar"></div>
        </aside>

        <main class="flex-1 flex flex-col p-12 bg-zinc-50 overflow-y-auto no-scrollbar relative">
            <div class="max-w-3xl w-full mx-auto space-y-8">
                
                <div class="bg-white border-4 border-black p-10 shadow-[12px_12px_0px_0px_rgba(0,0,0,1)] relative">
                    <div class="flex justify-between items-center mb-6 border-b-2 border-black pb-4">
                        <div class="flex items-center gap-4">
                            <span id="activeId" class="mono font-black text-2xl">#NEW</span>
                            <span id="modeTag" class="bg-black text-white px-2 py-0.5 text-[10px] font-black hidden"></span>
                        </div>
                        <button onclick="showSearchLink()" class="text-[10px] font-black border-2 border-black px-3 py-1 hover:bg-black hover:text-white uppercase">尋找卡片連結</button>
                    </div>

                    <textarea id="cardInput" class="w-full h-80 text-2xl outline-none leading-relaxed placeholder-zinc-100" placeholder="在此記錄思考..."></textarea>
                    
                    <div class="mt-8 flex justify-between items-end border-t-2 border-black pt-6">
                        <div class="flex gap-4">
                            <button onclick="saveCard()" class="bg-black text-white px-10 py-3 font-900 text-sm uppercase">File Card</button>
                            <button onclick="toggleBoard(true)" class="border-2 border-black px-6 py-3 font-900 text-sm uppercase">Board</button>
                        </div>
                        <div class="text-right">
                            <p class="text-[9px] font-black text-zinc-300">⌘⇧1:Quote | ⌘⇧2:Idea | ⌘⇧S:Save</p>
                        </div>
                    </div>
                </div>

                <div id="linkVisualizer" class="grid grid-cols-2 gap-6 hidden">
                    <div class="border-4 border-black p-6 bg-white">
                        <p class="text-[10px] font-black uppercase mb-4 border-b border-black pb-1">Outgoing (引用了)</p>
                        <div id="outList" class="flex flex-wrap gap-2"></div>
                    </div>
                    <div class="border-4 border-black p-6 bg-white">
                        <p class="text-[10px] font-black uppercase mb-4 border-b border-black pb-1">Backlinks (被引用)</p>
                        <div id="backList" class="flex flex-wrap gap-2"></div>
                    </div>
                </div>
            </div>

            <div id="searchLinkPanel" class="hidden absolute top-12 left-1/2 -translate-x-1/2 w-96 bg-white border-4 border-black shadow-2xl p-6 z-[60]">
                <input type="text" id="quickSearch" oninput="doQuickSearch()" placeholder="輸入內容關鍵字尋找編號..." class="w-full border-b-2 border-black mb-4 outline-none font-bold">
                <div id="searchResults" class="max-h-60 overflow-y-auto space-y-2 no-scrollbar"></div>
                <button onclick="this.parentElement.classList.add('hidden')" class="w-full mt-4 text-[10px] font-black opacity-30">CLOSE</button>
            </div>
        </main>
    </div>

    <div id="boardOverlay" class="hidden fixed inset-0 bg-white z-[100] p-12 overflow-y-auto">
        <div id="boardGrid" class="grid grid-cols-1 md:grid-cols-3 gap-8 pt-10"></div>
        <button onclick="toggleBoard(false)" class="fixed bottom-10 right-10 bg-black text-white px-8 py-3 font-black">CLOSE BOARD</button>
    </div>

<script>
    let cards = JSON.parse(localStorage.getItem('zet_v6')) || [];
    let currentMode = null;
    let activeFid = null;

    window.onload = () => {
        renderKeywords();
        initShortcuts();
    };

    function initShortcuts() {
        document.addEventListener('keydown', e => {
            const cmdShift = e.metaKey && e.shiftKey;
            if (cmdShift && e.key === '1') { e.preventDefault(); setMode('摘錄'); }
            if (cmdShift && e.key === '2') { e.preventDefault(); setMode('Idea'); }
            if (cmdShift && e.key === 's') { e.preventDefault(); saveCard(); }
            if (cmdShift && e.key === 'b') { e.preventDefault(); toggleBoard(); }
            if (e.key === 'Escape') {
                document.getElementById('searchLinkPanel').classList.add('hidden');
                toggleBoard(false);
            }
        });
    }

    function setMode(m) {
        currentMode = (currentMode === m) ? null : m;
        const tag = document.getElementById('modeTag');
        if(currentMode) { tag.innerText = currentMode.toUpperCase(); tag.classList.remove('hidden'); }
        else tag.classList.add('hidden');
    }

    function saveCard() {
        const content = document.getElementById('cardInput').value.trim();
        if(!content) return;
        const id = (Math.floor(Date.now() / 1000) % 0xFFFF).toString(16).toUpperCase().padStart(4, '0');
        const tags = (content.match(/#[^\s]+/g) || []).map(t => t.substring(1));
        
        const card = { id, fullId: Date.now(), content, tags, mode: currentMode, time: Date.now() };
        cards.unshift(card);
        localStorage.setItem('zet_v6', JSON.stringify(cards));
        
        document.getElementById('cardInput').value = "";
        currentMode = null;
        document.getElementById('modeTag').classList.add('hidden');
        renderKeywords();
    }

    function renderKeywords() {
        const stats = {};
        cards.forEach(c => c.tags.forEach(t => stats[t] = (stats[t] || 0) + 1));
        const box = document.getElementById('keywordBox');
        const term = document.getElementById('kwSearch').value.toLowerCase();

        box.innerHTML = Object.entries(stats)
            .filter(([t]) => t.toLowerCase().includes(term))
            .map(([t, count]) => `
            <div class="kw-item p-4 flex justify-between items-center" onclick="showCardsByTag('${t}')">
                <span class="font-900 text-xs">#${t}</span>
                <div class="flex items-center gap-3">
                    <span class="mono text-[10px] opacity-40">${count}</span>
                    <button onclick="event.stopPropagation(); deleteTag('${t}')" class="text-zinc-300 hover:text-black">×</button>
                </div>
            </div>
        `).join('');
    }

    function showSearchLink() {
        document.getElementById('searchLinkPanel').classList.remove('hidden');
        document.getElementById('quickSearch').focus();
    }

    function doQuickSearch() {
        const q = document.getElementById('quickSearch').value.toLowerCase();
        const results = document.getElementById('searchResults');
        if(!q) { results.innerHTML = ""; return; }

        results.innerHTML = cards.filter(c => c.content.toLowerCase().includes(q)).map(c => `
            <div onclick="insertLinkId('${c.id}')" class="border-2 border-black p-2 cursor-pointer hover:bg-black hover:text-white transition">
                <div class="flex justify-between text-[9px] font-black"><span>#${c.id}</span><span>${new Date(c.time).toLocaleDateString()}</span></div>
                <div class="text-[10px] line-clamp-1">${c.content.substring(0,40)}</div>
            </div>
        `).join('');
    }

    function insertLinkId(id) {
        const input = document.getElementById('cardInput');
        input.value += ` [[${id}]] `;
        document.getElementById('searchLinkPanel').classList.add('hidden');
        input.focus();
    }

    function loadCard(fid) {
        const card = cards.find(c => c.fullId == fid);
        activeFid = fid;
        document.getElementById('cardInput').value = card.content;
        document.getElementById('activeId').innerText = `#${card.id}`;
        
        const visual = document.getElementById('linkVisualizer');
        visual.classList.remove('hidden');

        // Outgoing
        const outIds = (card.content.match(/\[\[([A-Z0-9]{4})\]\]/g) || []).map(m => m.slice(2, -2));
        document.getElementById('outList').innerHTML = outIds.map(id => `
            <div class="link-node" onclick="jumpToId('${id}')">TO #${id}</div>
        `).join('') || '<span class="text-[10px] opacity-20 text-black">None</span>';

        // Backlinks
        const back = cards.filter(c => c.content.includes(`[[${card.id}]]`));
        document.getElementById('backList').innerHTML = back.map(c => `
            <div class="link-node backlink-node" onclick="loadCard('${c.fullId}')">FROM #${c.id}</div>
        `).join('') || '<span class="text-[10px] opacity-20 text-black">None</span>';
    }

    function jumpToId(id) {
        const c = cards.find(x => x.id === id);
        if(c) loadCard(c.fullId);
        else alert("找不到此卡片");
    }

    function showCardsByTag(tag) {
        toggleBoard(true);
        const filtered = cards.filter(c => c.tags.includes(tag));
        renderBoard(filtered);
    }

    function toggleBoard(show) {
        const b = document.getElementById('boardOverlay');
        if(show) { b.classList.remove('hidden'); renderBoard(cards); }
        else b.classList.add('hidden');
    }

    function renderBoard(data) {
        document.getElementById('boardGrid').innerHTML = data.map(c => `
            <div class="border-4 border-black p-8 bg-white shadow-[8px_8px_0px_0px_rgba(0,0,0,1)] relative">
                <div class="flex justify-between mb-4 border-b-2 border-black pb-2">
                    <span class="mono font-black">#${c.id}</span>
                    <button onclick="loadCard('${c.fullId}'); toggleBoard(false);" class="text-[10px] font-black underline">EDIT</button>
                </div>
                <div class="text-sm font-bold leading-relaxed mb-6">${marked.parse(c.content)}</div>
                <div class="flex gap-2">
                    ${c.tags.map(t => `<span class="text-[9px] font-black bg-black text-white px-1">#${t}</span>`).join('')}
                </div>
            </div>
        `).join('');
    }

    function exportMarkdown() {
        let output = "";
        cards.forEach(c => {
            output += `---
ID: ${c.id}
Date: ${new Date(c.time).toISOString()}
Tags: ${c.tags.join(', ')}
---
# ${c.mode || 'Zettel'}
${c.content}\n\n`;
        });
        const blob = new Blob([output], {type: 'text/markdown'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `MyZettelSync_Export.md`;
        a.click();
    }

    function deleteTag(tag) {
        if(confirm(`將從所有卡片中移除 #${tag}？`)) {
            cards.forEach(c => {
                c.content = c.content.replace(new RegExp(`#${tag}`, 'g'), '');
                c.tags = c.tags.filter(t => t !== tag);
            });
            localStorage.setItem('zet_v6', JSON.stringify(cards));
            renderKeywords();
        }
    }
</script>
</body>
</html>
