<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ZettelStudio | GitHub Cloud v12</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dropbox.js/10.11.0/Dropbox-sdk.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@700&family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background: #f5f5f5; height: 100vh; overflow: hidden; color: #1a1a1a; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* 佈局控制 */
        #midEditor, #midBoard, #studioSide { display: none; }
        .view-input #midEditor { display: flex; }
        .view-board #midBoard { display: flex; }
        .view-studio #studioSide { display: flex; flex: 1; }
        .view-studio.show-board #midBoard { display: flex; width: 450px; border-right: 4px solid black; }

        /* 卡片尺寸固定 */
        .card-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, 280px); 
            grid-auto-rows: 320px; 
            gap: 1.5rem; 
            justify-content: center;
        }
        .board-card { border: 3px solid #000; background: #fff; box-shadow: 6px 6px 0 #000; overflow: hidden; display: flex; flex-direction: column; cursor: pointer; transition: 0.1s; }
        .board-card:hover { transform: translate(-2px, -2px); box-shadow: 8px 8px 0 #000; }
        .idx-item { border-bottom: 1px solid rgba(0,0,0,0.05); transition: 0.2s; cursor: pointer; font-size: 11px; padding: 12px 16px; font-weight: 700; }
        .idx-item:hover { background: #000; color: #fff; }
        .active-btn { background: black !important; color: white !important; }
        
        /* 連結模式視覺 */
        .linking-mode .board-card { border-color: #2563eb; outline: 3px solid #2563eb; }
        .z-link { background: #000; color: #fff; padding: 0 4px; font-family: 'JetBrains Mono'; font-size: 10px; }
    </style>
</head>
<body id="mainBody" class="flex flex-col h-screen view-input">

    <header class="h-14 border-b-4 border-black flex items-center justify-between px-6 bg-white z-[100]">
        <div class="flex items-center gap-6">
            <h1 class="text-lg font-900 uppercase italic tracking-tighter">ZettelStudio</h1>
            <nav class="flex border-2 border-black divide-x-2 divide-black text-[10px] font-black uppercase">
                <button onclick="changeView('input')" id="n-input" class="px-4 py-1 active-btn">Capture (C+1)</button>
                <button onclick="changeView('board')" id="n-board" class="px-4 py-1">Vault (C+2)</button>
                <button onclick="changeView('studio')" id="n-studio" class="px-4 py-1">Studio (C+3)</button>
            </nav>
            <div id="linkBanner" class="hidden bg-blue-600 text-white text-[9px] font-black px-4 py-1 animate-pulse">LINKING MODE: CLICK TARGET CARD</div>
        </div>
        <div class="flex gap-3">
            <button id="studioBoardToggle" onclick="toggleStudioBoard()" class="hidden text-[9px] font-black border-2 border-black px-3 py-1 bg-yellow-400">SHOW BOARD</button>
            <button onclick="handleCloud()" id="cloudBtn" class="text-[9px] font-black border-2 border-black px-3 py-1 bg-blue-500 text-white uppercase">Link Dropbox</button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <aside class="w-60 border-r-4 border-black bg-white flex flex-col shrink-0">
            <div class="flex-1 overflow-y-auto no-scrollbar">
                <div class="p-3 bg-red-50 text-[8px] font-black text-red-600 border-b border-red-100 uppercase">Maintenance</div>
                <div class="idx-item flex justify-between text-red-600" onclick="filterBoard('review')"><span>Review Required</span><span id="c-r">0</span></div>

                <div class="p-3 bg-zinc-50 text-[8px] font-black opacity-40 border-b uppercase">Collections</div>
                <div class="idx-item flex justify-between" onclick="filterBoard('Idea')"><span>Idea 盒</span><span id="c-i">0</span></div>
                <div class="idx-item flex justify-between" onclick="filterBoard('摘錄')"><span>摘錄盒</span><span id="c-q">0</span></div>
                <div class="idx-item flex justify-between" onclick="filterBoard('archive')"><span>歸檔 (Archives)</span><span id="c-a">0</span></div>

                <div class="p-3 bg-zinc-50 text-[8px] font-black opacity-40 border-y uppercase">Keywords</div>
                <div id="tagBox"></div>

                <div class="p-3 bg-zinc-50 text-[8px] font-black opacity-40 border-y uppercase">Timeline</div>
                <div id="timeBox"></div>
            </div>
        </aside>

        <main id="midBoard" class="flex-[1.5] flex flex-col bg-zinc-100 overflow-hidden">
            <div class="p-4 flex justify-between items-center border-b border-black/5">
                <span id="boardTitle" class="text-[10px] font-black uppercase opacity-40 italic">Vault Content</span>
                <button onclick="pushToStudio()" class="text-[9px] font-black bg-black text-white px-3 py-1 hover:invert">PUSH SELECTED</button>
            </div>
            <div id="boardGrid" class="flex-1 overflow-y-auto p-8 card-grid no-scrollbar"></div>
        </main>

        <main id="midEditor" class="flex-1 flex flex-col items-center pt-24 bg-zinc-100">
            <div class="max-w-xl w-full bg-white p-8 border-4 border-black shadow-[12px_12px_0_0_#000]">
                <div class="flex border-2 border-black w-fit mb-4 text-[10px] font-black">
                    <button onclick="setType('Idea')" id="ti" class="px-4 py-1 bg-black text-white">IDEA (C+2)</button>
                    <button onclick="setType('摘錄')" id="tq" class="px-4 py-1">QUOTE (C+Q)</button>
                </div>
                <textarea id="mainIn" class="w-full h-64 text-xl outline-none leading-relaxed resize-none font-medium" placeholder="Capture thoughts... #tag"></textarea>
                <button onclick="saveCard()" class="mt-4 w-full bg-black text-white py-4 font-900 text-xs uppercase hover:bg-blue-600 transition-all">Save & Cloud Sync (Ctrl+S)</button>
            </div>
        </main>

        <aside id="studioSide" class="bg-white flex flex-col overflow-hidden">
            <div class="p-6 border-b-4 border-black flex flex-col gap-4">
                <input id="projName" class="font-900 text-2xl uppercase outline-none" value="Untitled Draft">
                <div class="flex gap-2">
                    <button onclick="exportDraft()" class="flex-1 bg-black text-white py-2 text-[10px] font-black">EXPORT (.md)</button>
                    <button onclick="clearStudio()" class="px-4 border-2 border-black text-[10px] font-black">CLEAR</button>
                </div>
            </div>
            <div id="studioCanvas" class="flex-1 overflow-y-auto p-10 no-scrollbar space-y-8"></div>
        </aside>
    </div>

<script>
    // 這裡已經填好了你的 App Key
    const CLIENT_ID = '2zshj5fwkxe18e6';
    let dbx = null;
    let cards = JSON.parse(localStorage.getItem('Z_Cards_V12')) || [];
    let project = JSON.parse(localStorage.getItem('Z_Proj_V12')) || { segments: [] };
    let currentType = 'Idea';
    let linkSourceId = null;

    // 視圖切換邏輯
    function changeView(v) {
        document.getElementById('mainBody').className = 'flex flex-col h-screen view-' + v;
        document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('active-btn'));
        document.getElementById('n-' + v).classList.add('active-btn');
        document.getElementById('studioBoardToggle').classList.toggle('hidden', v !== 'studio');
        if(v === 'board' || v === 'studio') renderBoard();
        if(v === 'studio') renderProject();
    }

    function toggleStudioBoard() { document.getElementById('mainBody').classList.toggle('show-board'); }

    // 快捷鍵
    window.addEventListener('keydown', e => {
        const ctrl = e.ctrlKey || e.metaKey;
        if(ctrl && e.key === 's') { e.preventDefault(); saveCard(); if(dbx) syncNow(); }
        if(ctrl && e.key === '1') changeView('input');
        if(ctrl && e.key === '2') changeView('board');
        if(ctrl && e.key === '3') changeView('studio');
        if(ctrl && e.key === 'q') setType('摘錄');
    });

    // Dropbox 授權與同步
    function handleCloud() {
        if(!dbx) {
            const dbxAuth = new Dropbox.DropboxAuth({ clientId: CLIENT_ID });
            const url = window.location.origin + window.location.pathname;
            window.location.href = dbxAuth.getAuthenticationUrl(url);
        } else { syncNow(); }
    }

    async function syncNow() {
        if(!dbx) return;
        const btn = document.getElementById('cloudBtn');
        btn.innerText = "Syncing...";
        try {
            await dbx.filesUpload({ path: '/zettel_vault.json', contents: JSON.stringify(cards), mode: 'overwrite' });
            await dbx.filesUpload({ path: '/zettel_studio.json', contents: JSON.stringify(project), mode: 'overwrite' });
            btn.innerText = "Sync OK";
        } catch(e) { btn.innerText = "Sync Err"; }
        setTimeout(() => btn.innerText = "Sync Now", 2000);
    }

    // 初始化
    window.onload = () => {
        const token = new URLSearchParams(window.location.hash.substring(1)).get('access_token');
        if(token) { localStorage.setItem('db_tk', token); window.history.replaceState({}, "", window.location.pathname); }
        const tk = localStorage.getItem('db_tk');
        if(tk) { dbx = new Dropbox.Dropbox({ accessToken: tk }); document.getElementById('cloudBtn').innerText = "Sync Now"; document.getElementById('cloudBtn').className = "text-[9px] font-black border-2 border-black px-3 py-1 bg-green-500 text-white uppercase"; }
        updateStats();
        changeView('input');
    };

    // 其他邏輯保持一致（saveCard, renderBoard, renderProject, updateStats 等）
    function setType(t) { currentType = t; document.getElementById('ti').className = t==='Idea'?'px-4 py-1 bg-black text-white':'px-4 py-1'; document.getElementById('tq').className = t==='摘錄'?'px-4 py-1 bg-black text-white':'px-4 py-1'; }
    function saveCard() {
        const val = document.getElementById('mainIn').value.trim();
        if(!val) return;
        const id = (Math.floor(Date.now() / 1000) % 0xFFFF).toString(16).toUpperCase().padStart(4, '0');
        const tags = (val.match(/#([^\s#]+)/g) || []).map(t => t.substring(1));
        cards.unshift({ id, content: val, mode: currentType, time: Date.now(), tags, status: 'active' });
        document.getElementById('mainIn').value = "";
        saveData(); updateStats();
    }
    function saveData() { localStorage.setItem('Z_Cards_V12', JSON.stringify(cards)); localStorage.setItem('Z_Proj_V12', JSON.stringify(project)); }
    function renderBoard(filter) {
        const grid = document.getElementById('boardGrid');
        let list = cards;
        if(filter) {
            if(filter === 'review') {
                const now = Date.now();
                const intervals = [1, 2, 7, 30].map(d => d * 86400000);
                list = cards.filter(c => intervals.some(int => Math.abs((now - c.time) - int) < 43200000));
            } else if(filter === 'archive') {
                list = cards.filter(c => c.status === 'archive');
            } else if(filter === 'Idea' || filter === '摘錄') {
                list = cards.filter(c => c.mode === filter && c.status !== 'archive');
            } else if(filter.startsWith('time:')) {
                const t = filter.split(':')[1];
                list = cards.filter(c => { const d = new Date(c.time); return `${d.getFullYear()}.${d.getMonth()+1}` === t; });
            } else {
                list = cards.filter(c => c.tags.includes(filter));
            }
        } else { list = cards.filter(c => c.status !== 'archive'); }

        grid.innerHTML = list.map(c => `
            <div class="board-card p-5 flex flex-col" onclick="${linkSourceId ? `finishLink('${c.id}')` : `openEdit('${c.id}')`}">
                <div class="flex justify-between items-center text-[10px] font-black border-b border-black pb-2 mb-3">
                    <span class="mono">#${c.id}</span>
                    <button onclick="startLink('${c.id}', event)" class="hover:bg-blue-600 hover:text-white border border-black px-1">LINK</button>
                    <input type="checkbox" class="card-sel" value="${c.id}" onclick="event.stopPropagation()">
                </div>
                <div class="flex-1 text-sm overflow-y-auto no-scrollbar prose prose-sm">${marked.parse(c.content)}</div>
                <div class="mt-3 text-[8px] font-bold opacity-30 flex justify-between uppercase"><span>${c.mode}</span><span>${new Date(c.time).toLocaleDateString()}</span></div>
            </div>`).join('');
    }
    function updateStats() {
        document.getElementById('c-r').innerText = cards.filter(c => c.status !== 'archive').length; // 簡化邏輯演示
        document.getElementById('c-i').innerText = cards.filter(c => c.mode === 'Idea' && c.status !== 'archive').length;
        document.getElementById('c-q').innerText = cards.filter(c => c.mode === '摘錄' && c.status !== 'archive').length;
        document.getElementById('c-a').innerText = cards.filter(c => c.status === 'archive').length;
        const tags = {}; cards.forEach(c => c.tags.forEach(t => tags[t] = (tags[t]||0)+1));
        document.getElementById('tagBox').innerHTML = Object.entries(tags).map(([k,v]) => `<div class="idx-item flex justify-between" onclick="filterBoard('${k}')"><span>#${k}</span><span class="opacity-30">${v}</span></div>`).join('');
        const times = {}; cards.forEach(c => { const d = new Date(c.time); const k = `${d.getFullYear()}.${d.getMonth()+1}`; times[k] = (times[k]||0)+1; });
        document.getElementById('timeBox').innerHTML = Object.entries(times).sort().reverse().map(([k,v]) => `<div class="idx-item flex justify-between" onclick="filterBoard('time:${k}')"><span>${k}</span><span class="opacity-30">${v}</span></div>`).join('');
    }
    function startLink(id, e) { e.stopPropagation(); linkSourceId = id; document.body.classList.add('linking-mode'); document.getElementById('linkBanner').classList.remove('hidden'); }
    function finishLink(id) { if(linkSourceId && linkSourceId !== id) { const t = cards.find(x => x.id === id); t.content += `\n\nRelated: [[${linkSourceId}]]`; saveData(); } linkSourceId = null; document.body.classList.remove('linking-mode'); document.getElementById('linkBanner').classList.add('hidden'); renderBoard(); }
    function pushToStudio() { document.querySelectorAll('.card-sel:checked').forEach(cb => { project.segments.push({ type: 'card', id: cb.value }); project.segments.push({ type: 'text', content: '' }); }); saveData(); changeView('studio'); }
    function renderProject() { document.getElementById('studioCanvas').innerHTML = project.segments.map((seg, idx) => seg.type === 'card' ? `<div class="p-6 bg-zinc-50 border-l-[12px] border-black text-sm italic shadow-sm relative group"><div class="mb-2 mono font-black text-blue-600 text-[10px]">[[${seg.id}]]</div>${marked.parse(cards.find(x => x.id === seg.id).content)}</div>` : `<textarea oninput="project.segments[${idx}].content=this.value; saveData();" class="w-full min-h-[120px] text-lg outline-none bg-transparent border-b-2 border-zinc-100 focus:border-black py-4 leading-relaxed" placeholder="Develop thought...">${seg.content}</textarea>`).join(''); }
    function clearStudio() { if(confirm('Clear?')) { project.segments = []; saveData(); renderProject(); } }
</script>
</body>
</html>
